%@(#)  source_filename.rte     modif:17-09-2018
!==============================================================================
% File          : source_filename.rte   version 1.0
!------------------------------------------------------------------------------
% Description   : <short program description>
!------------------------------------------------------------------------------
% Author        : <developer name> - COMPANY
!==============================================================================
! 17-09-2018  XX  Creation
! 17-09-2018  XX  <comments>
!==============================================================================
!
! <detailed program description>
!
!==============================================================================
! input file     : <name or rule for naming input file>
! output file    : <name or rule for naming output file>
! temporary file : <name or rule for naming temporary file>
!==============================================================================

! Message definition


base "../trace/trace.cfg" TRACE,autoflush off
base "../fmbrasil_clientesped/fmbrasil_clientesped.cfg" fmbrasil_clientesped


#define TX_PROG_INFO "M97_COTY_SAP_OUT"
#include "include/generix_func.inc"
#include "include/M97_ASCII.inc"
#include "include/ERPFMviaCSV_v2.inc"
#include "include/SERIEHARMAN.inc"
#include "include/M62.inc"
!===========================================================

! Initialization section

begin

   nPos := 1
    nRec := 1
    SYSLOG := find(sSYSLOG,INDEX=number(pINDEX))




 load (0, build(sHOME,"/config/FM_wms_configuration.properties"), taPARAM)

        tToInfologPrefixFilename := taPARAM["ToInfologPrefixFilenameHARMAN"]


		tDbBase			:= "FMWMS"
		tDbBase2			:= "FMWMS2"
		tDbBase3			:= "FMWMS3"
	tDbUsername		:= taPARAM["WMSDBUSER"]
	tDbPassword		:= taPARAM["WMSDBPASS"]
	tDbUrl			:= taPARAM["WMSDBURL"]


	tDbUsernameUPDATES		:= taPARAM["WMSDBUSERUPDATES"]
	tDbPasswordUPDATES		:= taPARAM["WMSDBPASSUPDATES"]
	tDbUrlUPDATES		:= taPARAM["WMSDBURLUPDATES"]


bfSqlInit()


   if not bfSqlJdbc(tDbBase , tDbUsername,tDbPassword,tDbUrl) then
      print("FATAL ",tfSqlErrorStr())
      bfSqlClose(tDbBase)
	  bfMajtraceSerie("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na abertura do banco de dados: ",tfSqlErrorStr()))

      exit(1)
   endif



	 if not bfSqlJdbc(tDbBase2 , tDbUsernameUPDATES,tDbPasswordUPDATES,tDbUrlUPDATES) then
      print("FATAL ",tfSqlErrorStr())
      bfSqlClose(tDbBase)
	  bfMajtraceSerie("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na abertura do banco de dados: ",tfSqlErrorStr()))

      exit(1)
   endif



    tCODACTConst := "001"
    nContadorLinhasEscritas  := 0

nMainIndex := 0

endbegin

line(1:"00.00")
 tREFLIV := ""
bGeraArquivo := FALSE

endline












line(1:"97.40")
	tNUMREC_9740 := S_GEEX9740_NUMREC
	
	
	/*
	SELECT DISTINCT 
        NUMREC
       ,CASE
        WHEN REFORI ='' THEN NULL
        ELSE REFORI
        END NOTA_FISCAL
		FROM FGE50FM0N1.GERECD
		WHERE NUMREC = (SELECT DISTINCT NUMREC FROM FGE50FM0N1.GERECD WHERE NUMORI="97.40-NUMREC")

		Caso o resultado seja nulo, executar o segundo SELECT:

		SELECT NUMREC, TRIM(REFREC) NOTA_FISCAL
		FROM FGE50FM0N1.GERECE
		WHERE NUMREC="97.40-NUMREC"
	
	*/
	
	
	
	
	
	
	
	
	

								
								
								
									
									 
									tQuery := 	build("SELECT DISTINCT  "\
												"    NUMREC "\
												"   ,CASE "\
												"    WHEN REFORI ='' THEN NULL "\
												"    ELSE REFORI "\
												"    END NOTA_FISCAL "\
												"	FROM FGE50FM",tToInfologPrefixFilename,".GERECD "\
												"	WHERE NUMREC = (SELECT DISTINCT NUMREC FROM FGE50FM",tToInfologPrefixFilename,".GERECD WHERE NUMORI='",tNUMREC_9740,"')")
									 


									log("tQuery ",tQuery,NL)	

									   
									if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
												 print("FATAL ", tfSqlErrorStr())
												 bfMajtraceRubrica9740("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
												exit(1)
										
									endif

									if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
										 print("FATAL ", tfSqlErrorStr())
										  bfMajtraceRubrica9740("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
												exit(1)

									endif
									
									nResulqurtu := 0
									while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
										nResulqurtu++
										remove(taREFRECSplitado)
										taDb2Array["NOTA_FISCAL"] := peel(taDb2Array["NOTA_FISCAL"]," ")
										split(taDb2Array["NOTA_FISCAL"],taREFRECSplitado,".")
										taDb2Array["NOTA_FISCAL"] := taREFRECSplitado[1]
										if nResulqurtu= 1 then
										
											nSeqCsv := cSeqCsvHasbro
											tFileOutCSV := build(sHOME,"/ToInfolog/I-FGE50FM",tToInfologPrefixFilename,"GERERUB_HAR_",time("now" ,"%Y%m%d"),"_",build(nSeqCsv:R010),".DAT")
											tFileOutTempCSV := build(sHOME,"/ToInfolog/Temp/I-FGE50FM",tToInfologPrefixFilename,"GERERUB_HAR_",time("now" ,"%Y%m%d"),"_",build(nSeqCsv:R010),".DAT")
											tNameOutCSV := build("I-FGE50FM",tToInfologPrefixFilename,"GERERUB_HAR_",time("now" ,"%Y%m%d"),"_",build(nSeqCsv:R010),".DAT")
										
										
										
										
										
											!NUMREC;SNUREC;TYPRUB;CODRUB;VALRUB;VALNUM;DISPO;MAJCRE;MAJDAT;MAJHMS;MAJPGM;MAJUTI;MAJECR
											!21010001;0;2;NF01;12345-6;;;20210113;20210113;214620;GERE1RUB2;UFMQN1;QPADEV001
											print("NUMREC;SNUREC;TYPRUB;CODRUB;VALRUB;VALNUM;DISPO;MAJCRE;MAJDAT;MAJHMS;MAJPGM;MAJUTI;MAJECR",NL) >> tFileOutTempCSV
										endif
											tNUMLIVCSV := peel(taDb2Array["NUMREC"]," ")
											tSNULIVCSV := ""
											tTYPRUBCSV := "2"
											tCODRUBCSV := build("NF",nResulqurtu:R02)
											tVALRUBCSV := peel(taDb2Array["NOTA_FISCAL"]," ")
											tVALNUMCSV := ""
											tDISPOCSV  := ""
											tMAJCRECSV := time("now" ,"%Y%m%d")
											tMAJDATCSV := time("now" ,"%Y%m%d")
											tMAJHMSCSV := time("now" ,"%H%M%S")
											tMAJPGMCSV := "GERE1RUB2"
											tMAJUTICSV := build("UFM",tToInfologPrefixFilename)
											tMAJECRCSV := "QPADEV001"
									


											print(tNUMLIVCSV,";",tSNULIVCSV,";",tTYPRUBCSV \
													,";",tCODRUBCSV,";",tVALRUBCSV,";",tVALNUMCSV \
													,";",tDISPOCSV,";",tMAJCRECSV,";",tMAJDATCSV,";" \
													,tMAJHMSCSV,";",tMAJPGMCSV,";",tMAJUTICSV,";" \
													,tMAJECRCSV,";", NL) >> tFileOutTempCSV
										
										
										remove(taDb2Array)

									endwhile
									
									

									if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
										print("FATAL", tfSqlErrorStr())
										 bfMajtraceRubrica9740("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
												exit(1)
									endif
						
								
						
									if nResulqurtu >= 1 then
								
										close(tFileOutTempCSV)
										copy(tFileOutTempCSV,tFileOutCSV)
										close(tFileOutTempCSV)
										remove(tFileOutTempCSV)
										close(tFileOutCSV)




										bfMajtraceRubrica9740("Recebida","0",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos","")
									else ! se for 0
										!faz 2Âª query
										
										
										
										
										
										
																	tQuery := 	build("SELECT NUMREC, TRIM(REFREC) NOTA_FISCAL "\
																			"	FROM FGE50FM",tToInfologPrefixFilename,".GERECE "\
																			"	WHERE NUMREC ='",tNUMREC_9740,"'")
																 


																log("tQuery ",tQuery,NL)	

																   
																if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
																			 print("FATAL ", tfSqlErrorStr())
																			 bfMajtraceRubrica9740("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																			exit(1)
																	
																endif

																if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
																	 print("FATAL ", tfSqlErrorStr())
																	  bfMajtraceRubrica9740("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																			exit(1)

																endif
																
																nResulqurtu := 0
																while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
																	nResulqurtu++
																	remove(taREFRECSplitado)
																	taDb2Array["NOTA_FISCAL"] := peel(taDb2Array["NOTA_FISCAL"]," ")
																	split(taDb2Array["NOTA_FISCAL"],taREFRECSplitado,".")
																	taDb2Array["NOTA_FISCAL"] := taREFRECSplitado[1]
																	if nResulqurtu= 1 then
																	
																		nSeqCsv := cSeqCsvHasbro
																		tFileOutCSV := build(sHOME,"/ToInfolog/I-FGE50FM",tToInfologPrefixFilename,"GERERUB_HAR_",time("now" ,"%Y%m%d"),"_",build(nSeqCsv:R010),".DAT")
																		tFileOutTempCSV := build(sHOME,"/ToInfolog/Temp/I-FGE50FM",tToInfologPrefixFilename,"GERERUB_HAR_",time("now" ,"%Y%m%d"),"_",build(nSeqCsv:R010),".DAT")
																		tNameOutCSV := build("I-FGE50FM",tToInfologPrefixFilename,"GERERUB_HAR_",time("now" ,"%Y%m%d"),"_",build(nSeqCsv:R010),".DAT")
																	
																	
																	
																	
																	
																		!NUMREC;SNUREC;TYPRUB;CODRUB;VALRUB;VALNUM;DISPO;MAJCRE;MAJDAT;MAJHMS;MAJPGM;MAJUTI;MAJECR
																		!21010001;0;2;NF01;12345-6;;;20210113;20210113;214620;GERE1RUB2;UFMQN1;QPADEV001
																		print("NUMREC;SNUREC;TYPRUB;CODRUB;VALRUB;VALNUM;DISPO;MAJCRE;MAJDAT;MAJHMS;MAJPGM;MAJUTI;MAJECR",NL) >> tFileOutTempCSV
																	endif
																		tNUMLIVCSV := peel(taDb2Array["NUMREC"]," ")
																		tSNULIVCSV := ""
																		tTYPRUBCSV := "2"
																		tCODRUBCSV := build("NF",nResulqurtu:R02)
																		tVALRUBCSV := peel(taDb2Array["NOTA_FISCAL"]," ")
																		tVALNUMCSV := ""
																		tDISPOCSV  := ""
																		tMAJCRECSV := time("now" ,"%Y%m%d")
																		tMAJDATCSV := time("now" ,"%Y%m%d")
																		tMAJHMSCSV := time("now" ,"%H%M%S")
																		tMAJPGMCSV := "GERE1RUB2"
																		tMAJUTICSV := build("UFM",tToInfologPrefixFilename)
																		tMAJECRCSV := "QPADEV001"
																


																		print(tNUMLIVCSV,";",tSNULIVCSV,";",tTYPRUBCSV \
																				,";",tCODRUBCSV,";",tVALRUBCSV,";",tVALNUMCSV \
																				,";",tDISPOCSV,";",tMAJCRECSV,";",tMAJDATCSV,";" \
																				,tMAJHMSCSV,";",tMAJPGMCSV,";",tMAJUTICSV,";" \
																				,tMAJECRCSV,";", NL) >> tFileOutTempCSV
																	
																	
																	remove(taDb2Array)

																endwhile
																
																

																if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
																	print("FATAL", tfSqlErrorStr())
																	 bfMajtraceRubrica9740("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																			exit(1)
																endif
													
															
													
																if nResulqurtu >= 1 then
															
																	close(tFileOutTempCSV)
																	copy(tFileOutTempCSV,tFileOutCSV)
																	close(tFileOutTempCSV)
																	remove(tFileOutTempCSV)
																	close(tFileOutCSV)




																	bfMajtraceRubrica9740("Recebida","0",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos","")
										
										
																endif
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
										
	
									endif
	
	
	
	
	
	
	
	
	
	
endline













line(1:"97.50")

	tCODACTLido := S_GEEX9750_CODACT
	tNUMVAG := S_GEEX9750_NUMVAG
	tNUMLIV := S_GEEX9750_NUMLIV
!===========================================================
!===========================================================

!===========================================================
!===========================================================

/*
if index(S_GEEX9750_REFLIV,".") = 0 then
	bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro REFLIV sem PONTO"))
	exit(1)
	!nao faz nada
endif

*/
!1234.56UN
if index(S_GEEX9750_REFLIV,".") = 0 then
	tREFLIVaConsiderar := S_GEEX9750_REFLIV
	log("1 - tREFLIVaConsiderar ",tREFLIVaConsiderar,NL)
else
	!1234.18CX
	tDoisUltimoCaract :=  substr(S_GEEX9750_REFLIV,length(S_GEEX9750_REFLIV)-1,2)
	if tDoisUltimoCaract = "UN" or  tDoisUltimoCaract = "CX" then
		tREFLIVaConsiderar := substr(S_GEEX9750_REFLIV,1,length(S_GEEX9750_REFLIV)-2)
		log("2 - tREFLIVaConsiderar ",tREFLIVaConsiderar,NL)
	else
		tREFLIVaConsiderar := S_GEEX9750_REFLIV
		log("3 - tREFLIVaConsiderar ",tREFLIVaConsiderar,NL)
	endif
	split(S_GEEX9750_REFLIV, taPedido, ".")
endif





bFazPED := FALSE





! SCO----------------------------------------------------------------
!CONFIMACAO SEPARACAO

if S_GEEX9750_CODACT = "HAR" then

log("S_GEEX9750_ETALIV ",S_GEEX9750_ETALIV,NL)

if S_GEEX9750_ETALIV =  "30" then !fazer rubricas

		!ve qual Ã© o codmop
		
		!select numliv, refliv, codmop from FGE50FM",tToInfologPrefixFilename,".gelive where codmop in('MAS','VEN') and numvag='NUMVAG'
		tQuery := build("SELECT CODMOP FROM FGE50FM",tToInfologPrefixFilename,".GELIVE where codmop in('MAS','VEN') and numvag='",tNUMVAG,"'   ")
		log(NL,tQuery,NL)
		
		if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
				print("FATAL ", tfSqlErrorStr())
				bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				exit(1)
			
		endif

		if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
			 print("FATAL ", tfSqlErrorStr())
			 bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
			exit(1)

		endif

		while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
			tCODMOPQueryM62Val := peel(taDb2Array["CODMOP"]," ")
			if tCODMOPQueryM62Val= "VEN" then
				break
			endif
			remove(taDb2Array)
	
		endwhile	
		
		
		
		if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
			print("FATAL", tfSqlErrorStr())
			 bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
			exit(1)
		endif


			!SELECT // UPDATE // GERACAO M62

		if tCODMOPQueryM62Val = "VEN" then




			tQuery := build("SELECT DISTINCT LEFT (CHAR(CURRENT_TIMESTAMP),4)  "\
				"		   || SUBSTR(CHAR(CURRENT_TIMESTAMP),6,2) "\
				"		   || SUBSTR(CHAR(CURRENT_TIMESTAMP),9,2)  "\
				"		   || SUBSTR(CHAR(CURRENT_TIMESTAMP),12,2) "\
				"		   ||SUBSTR(CHAR(CURRENT_TIMESTAMP),15,2) "\
				"		   ||SUBSTR(CHAR(CURRENT_TIMESTAMP),18,2) REFMIT "\
				"		  ,SE.NUMLIV  "\
				"		  ,SE.NUMSUP "\
				"		  ,AH.TOULIV "\
				"		  ,AH.CODTRA "\
				"		  ,AH.NUMVAG "\
				"		  ,AH.DATLIV "\
				"		  ,AH.CODRGT "\
				"	FROM (SELECT MAX(A.DATLIV) DATLIV, B.CODRGT, B.CODTRA, A.TOULIV, A.NUMLIV, A.NUMVAG FROM FGE50FM",tToInfologPrefixFilename,".GESUPE A, FGE50FM",tToInfologPrefixFilename,".GELIVE B WHERE A.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') AND A.NUMLIV=B.NUMLIV GROUP BY A.TOULIV, A.NUMLIV, A.NUMVAG, B.CODTRA, B.CODRGT) AH "\
				"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
				"	ON AH.NUMVAG=SE.NUMVAG  "\
				"	WHERE AH.NUMVAG='",tNUMVAG,"' "\
				"	AND SE.TYPSUP<>3 "\
				"	AND SE.INDMAS <>'1'")


				tQuery := build("SELECT DISTINCT LEFT (CHAR(CURRENT_TIMESTAMP),4) "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),6,2) "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),9,2) "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),12,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),15,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),18,2) REFMIT "\
"      ,SE.NUMLIV "\
"      ,SE.NUMSUP "\
"      ,LPAD(AH.TOULIV,4,0) TOULIV "\
"      ,AH.CODTRA "\
"      ,AH.NUMVAG "\
"      ,AH.DATLIV "\
"      ,AH.CODRGT "\
"FROM (SELECT MAX(A.DATLIV) DATLIV, B.CODRGT, B.CODTRA, A.TOULIV, A.NUMLIV, A.NUMVAG FROM FGE50FM",tToInfologPrefixFilename,".GESUPE A, FGE50FM",tToInfologPrefixFilename,".GELIVE B WHERE A.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') AND A.NUMLIV=B.NUMLIV AND A.TOULIV<>0 GROUP BY A.TOULIV, A.NUMLIV, A.NUMVAG, B.CODTRA, B.CODRGT) AH "\
"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
"ON AH.NUMVAG=SE.NUMVAG "\
"WHERE AH.NUMVAG='",tNUMVAG,"' "\
"AND SE.TYPSUP<>3 "\
"AND SE.INDMAS <>'1' ")


				tQuery := build("SELECT DISTINCT LEFT (CHAR(CURRENT_TIMESTAMP),4)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),6,2) "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),9,2)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),12,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),15,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),18,2) REFMIT "\
"      ,SE.NUMLIV  "\
"      ,SE.NUMSUP "\
"      ,SE.KAILIV "\
"      ,AH.TOULIV "\
"      ,AH.CODTRA "\
"      ,AH.NUMVAG "\
"      ,AH.DATLIV "\
"      ,AH.CODRGT "\
"FROM (SELECT MAX(A.DATLIV) DATLIV, B.CODRGT, B.CODTRA, A.TOULIV, A.NUMLIV, A.NUMVAG FROM FGE50FM",tToInfologPrefixFilename,".GESUPE A, FGE50FM",tToInfologPrefixFilename,".GELIVE B WHERE A.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') AND A.NUMLIV=B.NUMLIV GROUP BY A.TOULIV, A.NUMLIV, A.NUMVAG, B.CODTRA, B.CODRGT) AH "\
"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
"ON AH.NUMVAG=SE.NUMVAG  "\
"WHERE AH.NUMVAG='",tNUMVAG,"' "\
"AND SE.TYPSUP<>3 "\
"AND SE.INDMAS <>'1' ")






				tQuery := build("SELECT DISTINCT LEFT (CHAR(CURRENT_TIMESTAMP),4)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),6,2) "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),9,2)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),12,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),15,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),18,2) REFMIT "\
"      ,SE.NUMLIV  "\
"      ,SE.NUMSUP "\
"      ,AH.TOULIV "\
"      ,AH.CODTRA "\
"      ,AH.NUMVAG "\
"      ,AH.HEILIV "\
"      ,AH.DATLIV "\
"      ,AH.CODRGT "\
"FROM (SELECT MAX(A.DATLIV) DATLIV, MAX(B.HEILIV) HEILIV,B.CODRGT, B.CODTRA, A.TOULIV, A.NUMLIV, A.NUMVAG FROM FGE50FM",tToInfologPrefixFilename,".GESUPE A, FGE50FM",tToInfologPrefixFilename,".GELIVE B WHERE A.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') AND A.NUMLIV=B.NUMLIV GROUP BY A.TOULIV, A.NUMLIV, A.NUMVAG, B.CODTRA, B.CODRGT) AH "\
"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
"ON AH.NUMVAG=SE.NUMVAG  "\
"WHERE AH.NUMVAG='",tNUMVAG,"' "\
"AND SE.TYPSUP<>3 "\
"AND SE.INDMAS <>'1' ")



				tQuery := build("SELECT DISTINCT LEFT (CHAR(CURRENT_TIMESTAMP),4)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),6,2) "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),9,2)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),12,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),15,2) "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),18,2) REFMIT "\
"      ,SE.NUMLIV  "\
"      ,SE.NUMSUP "\
"      ,AH.TOULIV "\
"      ,AH.CODTRA "\
"      ,AH.NUMVAG "\
"      ,AH.HEILIV "\
"      ,AH.DATLIV "\
"      ,AH.CODRGT "\
"      ,AH.KAILIV "\
"      ,AH.NUMTOU "\
"FROM (SELECT MAX(A.DATLIV) DATLIV, MAX(B.HEILIV) HEILIV,B.CODRGT, B.CODTRA, B.NUMTOU, A.TOULIV, A.NUMLIV, A.NUMVAG, A.KAILIV FROM FGE50FM",tToInfologPrefixFilename,".GESUPE A, FGE50FM",tToInfologPrefixFilename,".GELIVE B WHERE A.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') AND A.NUMLIV=B.NUMLIV GROUP BY A.TOULIV, A.NUMLIV, A.NUMVAG, B.CODTRA,B.NUMTOU, B.CODRGT, A.KAILIV) AH "\
"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
"ON AH.NUMVAG=SE.NUMVAG  "\
"WHERE AH.NUMVAG='",tNUMVAG,"' "\
"AND SE.TYPSUP<>3 "\
"AND SE.INDMAS <>'1' ")

/*
				tQuery := build("SELECT DISTINCT LEFT (CHAR(CURRENT_TIMESTAMP),4)   "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),6,2)  "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),9,2)   "\
"       || SUBSTR(CHAR(CURRENT_TIMESTAMP),12,2)  "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),15,2)  "\
"       ||SUBSTR(CHAR(CURRENT_TIMESTAMP),18,2) REFMIT  "\
"      ,SE.NUMLIV   "\
"      ,SE.NUMSUP  "\
"      ,AH.TOULIV  "\
"      ,AH.CODTRA  "\
"      ,AH.NUMVAG  "\
"      ,AH.HEILIV  "\
"      ,MIN(AH.DATLIV) DATLIV "\
"      ,AH.CODRGT  "\
"      ,AH.KAILIV  "\
"      ,AH.NUMTOU  "\
"FROM (SELECT MAX(A.DATLIV) DATLIV, MAX(B.HEILIV) HEILIV,B.CODRGT, B.CODTRA, B.NUMTOU, A.TOULIV, A.NUMLIV, A.NUMVAG, A.KAILIV FROM FGE50FM",tToInfologPrefixFilename,".GESUPE A, FGE50FM",tToInfologPrefixFilename,".GELIVE B WHERE A.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') AND A.NUMLIV=B.NUMLIV GROUP BY A.TOULIV, A.NUMLIV, A.NUMVAG, B.CODTRA,B.NUMTOU, B.CODRGT, A.KAILIV) AH  "\
"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPE SE  "\
"ON AH.NUMVAG=SE.NUMVAG   "\
"WHERE AH.NUMVAG='",tNUMVAG,"' "\
"AND SE.TYPSUP<>3  "\
"AND SE.INDMAS <>'1'  "\
"GROUP BY SE.NUMLIV   "\
"      ,SE.NUMSUP  "\
"      ,AH.TOULIV  "\
"      ,AH.CODTRA  "\
"      ,AH.NUMVAG  "\
"      ,AH.HEILIV  "\
"      ,AH.CODRGT  "\
"      ,AH.KAILIV  "\
"      ,AH.NUMTOU  "\
"order by SE.NUMLIV")
*/
				log("tQuery ",tQuery,NL)

								if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
											 log("FATAL ", tfSqlErrorStr(),NL,tQuery)
											 bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
											exit(1)

								endif

								if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
									 log("FATAL ", tfSqlErrorStr(),NL,tQuery)
									  bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
											exit(1)

								endif

								bQueryTemResul := FALSE
								nContItemsQueryM62 := 0
								while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
									bQueryTemResul := TRUE
									nContItemsQueryM62++

									tTOULIVQueryM62 := peel(taDb2Array["TOULIV"]," ")
									tTOULIVQueryM62 := build(number(tTOULIVQueryM62):R04)
									tCODRGTQueryM62 := peel(taDb2Array["CODRGT"]," ")
									tREFMITQueryM62 := peel(taDb2Array["REFMIT"]," ")
									tCODTRAQueryM62 := peel(taDb2Array["CODTRA"]," ")
									tDATLIVQueryM62 := peel(taDb2Array["DATLIV"]," ")
									tHEILIVQueryM62 := peel(taDb2Array["HEILIV"]," ")
									taNUMLIVQueryM62[nContItemsQueryM62] := peel(taDb2Array["NUMLIV"]," ")
									taNUMSUPQueryM62[nContItemsQueryM62] := peel(taDb2Array["NUMSUP"]," ")
									taKAILIVQueryM62[nContItemsQueryM62] := peel(taDb2Array["KAILIV"]," ")
									taKAILIVQueryM62[nContItemsQueryM62] := build(number(taKAILIVQueryM62[nContItemsQueryM62]):R03)

									remove(taDb2Array)

								endwhile



								if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
									log("FATAL ", tfSqlErrorStr(),NL,tQuery)
									 bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
											exit(1)
								endif










							if bQueryTemResul = TRUE then
								bNaoFazM62 := FALSE
								TRACE := find(build(sHOME,"/trace"),MENSAGEM=build("M97 - M62 - ",tNUMVAG),PERFIL="HARMAN")
								if valid(TRACE) then
										bNaoFazM62 := TRUE
								endif
								if bNaoFazM62 = FALSE then




										tQueryUpdadeM62 := build("UPDATE FGE50FM",tToInfologPrefixFilename,".GELIVE SET TOULIV='",tTOULIVQueryM62,"' , CODRGT='",tCODRGTQueryM62,"' , HEILIV='",tHEILIVQueryM62,"' WHERE NUMVAG='",tNUMVAG,"' WITH NONE")


									log(tQueryUpdadeM62,NL)


									!colocar aqui o update


											if not bfSqlSet(tDbBase2, "Updatedb2", tQueryUpdadeM62) then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("1 - Erro na execucao da query ",tQueryUpdadeM62," do banco de dados: ",tfSqlErrorStr()))
											  exit(27)
										   endif
										   if not bfSqlExec(tDbBase2, "Updatedb2") then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("2 - Erro na execucao da query ",tQueryUpdadeM62," do banco de dados: ",tfSqlErrorStr()))
											  exit(28)
										   endif
										   if not bfSqlCommit(tDbBase2, "Updatedb2") then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("3 - Erro na execucao da query ",tQueryUpdadeM62," do banco de dados: ",tfSqlErrorStr()))
											  exit(29)
										   endif
										   if not bfSqlFree(tDbBase2, "Updatedb2") then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceM62("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("4 - Erro na execucao da query ",tQueryUpdadeM62," do banco de dados: ",tfSqlErrorStr()))
											  exit(30)
										   endif












															nMessageID := cMessageID

													   tFileOutM62 := build(sHOME,"/ToInfolog/",tToInfologPrefixFilename,"62",build(nMessageID:R015),".DAT")
													  tFileOutTempM62 := build(sHOME,"/ToInfolog/Temp/",tToInfologPrefixFilename,"62",build(nMessageID:R015),".DAT")
													  tNameOutM62 := build(tToInfologPrefixFilename,"62",build(nMessageID:R015),".DAT")


														 R_00HEADER_CODEXC("00")
														 R_00HEADER_SEPEXC(".")
														 R_00HEADER_SCOEXC("00")
														 R_00HEADER_TRTEXC("")
														 R_00HEADER_EMTEXC("FM")
														 R_00HEADER_RCTEXC("")
														 R_00HEADER_DATEXC(time("now" ,"%Y%m%d"))
														 R_00HEADER_HEUEXC(time("now" ,"%H%M%S"))
														 R_00HEADER_NUMEXC("0000000")
														 R_00HEADER_ACQEXC("0")
														 R_00HEADER_VEREXC("5.00")
														 R_00HEADER_NOMSYS("")
														 R_00HEADER_NOMDTQ("M62")
														 R_00HEADER_BIBDTQ("")
														 R_00HEADER_LIBEXC(tLIBEXC) !(build(nMessageID:R010))
														 R_00HEADER_BIBDST("")
														 R_00HEADER_PGMDST("")
														 R_00HEADER_PARDST("")
														 R_00HEADER_CODACT("")
														 R_00HEADER_IGLSIT("")
														 R_00HEADER_EDISIT(build(number(tCentro_De_Custo)))
														 R_00HEADER_IMAEXC("")
														 R_00HEADER_DISEXC("")

														 flush(0,0,NL) >> tFileOutTempM62   !ESCRITA DO HEADER M00.00


														 R_M6200_CODEXC("62")
														 R_M6200_SEPEXC(".")
														 R_M6200_SCOEXC("00")
														 R_M6200_TRTEXC("2")




														 R_M6200_TOULIV(tTOULIVQueryM62)
														 R_M6200_DATLIV(tDATLIVQueryM62)
														 !R_M6200_HEILIV(tHEILIVQueryM62)
														 R_M6200_REFMIT(tREFMITQueryM62)
														 !R_M6200_MSGEXP(taCrachaVeiculo[nTempNumeroRegistoAgenda])
														 R_M6200_KAILIV(taKAILIVQueryM62[1])
														 R_M6200_CODTRA(tCODTRAQueryM62)
														 nContadorLinhasEscritas++
														flush(0,0,NL)  >> tFileOutTempM62


																!colocar while
																nTempContItemsQueryM62 := 1
																while nTempContItemsQueryM62 <= nContItemsQueryM62	do



																				 R_M6220_CODEXC("62")
																				 R_M6220_SEPEXC(".")
																				 R_M6220_SCOEXC("20")
																				 R_M6220_TRTEXC("2")
																				 R_M6220_REFMIT(tREFMITQueryM62)
																				 R_M6220_NUMLIV(taNUMLIVQueryM62[nTempContItemsQueryM62])
																				 R_M6220_NUMSUP(taNUMSUPQueryM62[nTempContItemsQueryM62])
																				 R_M6220_KAILIV(taKAILIVQueryM62[nTempContItemsQueryM62])
																				 nContadorLinhasEscritas++
																				 flush(0,0,NL)  >> tFileOutTempM62


																				nTempContItemsQueryM62++
																endwhile






														R_99FILEFOOTER_CODEXC("99")
														R_99FILEFOOTER_SEPEXC(".")
														R_99FILEFOOTER_SCOEXC("00")
														R_99FILEFOOTER_TRTEXC("")
														R_99FILEFOOTER_EMTEXC("FM")
														R_99FILEFOOTER_RCTEXC("")
														R_99FILEFOOTER_DATEXC(time("now" ,"%Y%m%d"))
														R_99FILEFOOTER_HEUEXC(time("now" ,"H%M%S"))
														R_99FILEFOOTER_NUMEXC("")
														tContadorLinhasEscritas := build(nContadorLinhasEscritas)
														!print(tContadorLinhasEscritas) > "c:/influe/tContadorLinhasEscritas.txt"
														R_99FILEFOOTER_CPTEXC(build(number(tContadorLinhasEscritas):R08.0)) !VER NUMERO DE REGISTOS EXEPTO HEADER E TRAILLER
														!R_99FILEFOOTER_NOMSYS("")
														!R_99FILEFOOTER_NOMDTQ("")
														!R_99FILEFOOTER_BIBDTQ("")
														!R_99FILEFOOTER_IDEMSG("")
														!R_99FILEFOOTER_DISEXC("")

														flush(0,0,NL)  >> tFileOutTempM62
														close(tFileOutTempM62)






													   bfMajtraceM62("Recebida","0",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos","")




														copy(tFileOutTempM62,tFileOutM62)
															close(tFileOutTempM62)
															remove(tFileOutTempM62)
																close(tFileOutM62)




								endif



							endif





		endif
	endif





	! GERAÃÃO DO CONFIRMACAO DE PEDIDO - TOTVS RM
		if S_GEEX9750_ETALIV = "30"  then  ! PED FM
			tQuery := build("SELECT VALRUB", NL," "\
							"FROM FGE50FM",tToInfologPrefixFilename,".GELIRUB", NL," "\
							"WHERE CODRUB = 'CDFM'", NL," "\
							"AND NUMLIV = '",S_GEEX9750_NUMLIV,"'")

			if bfSqlSet(tDbBase, "SELECTdb2", tQuery) = FALSE then
				log("FATAL ", tfSqlErrorStr(),NL,tQuery)
				bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				exit(1)
			endif

			if bfSqlOpen(tDbBase, "SELECTdb2") = FALSE then
				log("FATAL ", tfSqlErrorStr(),NL,tQuery)
				bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				exit(1)
			endif

			while bfSqlFetchArray(tDbBase, "SELECTdb2", taDb2Array) = TRUE do
				tValrub := peel(taDb2Array["VALRUB"], " ")
				remove(taDb2Array)
			endwhile

			if bfSqlFree(tDbBase, "SELECTdb2") = FALSE then
				log("FATAL ", tfSqlErrorStr(),NL,tQuery)
				bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				exit(1)
			endif

			if length(tValrub) = 0 then
				tQuery := build("SELECT VALRUB", NL," "\
								"FROM FGE50FM",tToInfologPrefixFilename,".GEACRUB", NL," "\
								"WHERE CODRUB = 'CDFM' AND CODACT = 'HAR'")			  
								
				log(tQuery, NL)
			
				if bfSqlSet(tDbBase, "SELECTdb2", tQuery) = FALSE then
					print("FATAL ", tfSqlErrorStr())
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				if bfSqlOpen(tDbBase, "SELECTdb2") = FALSE then
					print("FATAL ", tfSqlErrorStr())
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				while bfSqlFetchArray(tDbBase, "SELECTdb2", taDb2Array) = TRUE do
					tValrub := peel(taDb2Array["VALRUB"]," ")
					remove(taDb2Array)
				endwhile

				if bfSqlFree(tDbBase, "SELECTdb2") = FALSE then
					print("FATAL", tfSqlErrorStr())
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif
			endif

			fmbrasil_clientesped := find(build(sHOME,"/fmbrasil_clientesped"),CNPJFILIAL=tValrub,CODACT=tCODACTLido)

			if valid(fmbrasil_clientesped) then
				! segue processo normalmente
				if length(fmbrasil_clientesped.CODIGOFABRICANTE) > 0 and length(fmbrasil_clientesped.CODERP) > 0 and length(fmbrasil_clientesped.CODACT) > 0 then
					bFazPED := TRUE
				endif
			else
				log("Sem dados na tabela para codact ",tCODACTLido, " e CNPJ_FILIAL ", tValrub, NL)
			endif

			TRACE := find(build(sHOME,"/trace"),NUMDOC=tREFLIVaConsiderar,MENSAGEM=build("CONFIRMACAO DE PEDIDO - TOTVS RM"),PERFIL="HARMAN",LIBEXC=tNUMVAG)
			
			if valid(TRACE) then
				bFazPED := FALSE
			endif

			if bFazPED = TRUE then
				log("bFazPED = TRUE",NL)
			else
				log("bFazPED = FALSE",NL)
			endif

			if bFazPED = TRUE then
				nMessageID := cMessageID
				if tValrub = "02462805002550" then
					tFileOutPED := build(sHOME,"/FMBR_AS2/FM",tToInfologPrefixFilename,"HARPED.NSR_",time("now" ,"%Y%m%d%H%M%S"),".CSV")
					tFileOutTempPED := build(sHOME,"/FMBR_AS2/Temp/FM",tToInfologPrefixFilename,"HARPED.NSR_",time("now" ,"%Y%m%d%H%M%S"),".CSV")
					tNameOutPED := build("FM",tToInfologPrefixFilename,"HARPED.NSR_",time("now" ,"%Y%m%d%H%M%S"),".CSV")
				else
					tFileOutPED := build(sHOME,"/FMBR_AS2/FM",tToInfologPrefixFilename,"HARPED.",time("now" ,"%Y%m%d%H%M%S"),".CSV")
					tFileOutTempPED := build(sHOME,"/FMBR_AS2/Temp/FM",tToInfologPrefixFilename,"HARPED.",time("now" ,"%Y%m%d%H%M%S"),".CSV")
					tNameOutPED := build("FM",tToInfologPrefixFilename,"HARPED.",time("now" ,"%Y%m%d%H%M%S"),".CSV")
				endif

				tQuery := build("SELECT SUM (PDNUVC*UVCLIV) AS PESOLIQUIDO, ROUND(SUM ((UVCLIV/PCBPRO)*PDBCOL),2) PESOBRUTO, COUNT (CODPAL) VOLUMES "\
				"FROM  FGE50FM",tToInfologPrefixFilename,".GESUPD "\
				"WHERE REFLIV LIKE '",tREFLIVaConsiderar,"%'")

				if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
					log("FATAL ", tfSqlErrorStr(),NL,tQuery)
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
					log("FATAL ", tfSqlErrorStr(),NL,tQuery)
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				bQueryTemResul := FALSE
				while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
					bQueryTemResul := TRUE
					remove(taDb2Array)
				endwhile

				if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
					log("FATAL ", tfSqlErrorStr(),NL,tQuery)
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				tQuery := build("SELECT  DISTINCT RIGHT(lpad(OD.DATVAG,8,0),2)||'/'||substr(lpad(OD.DATVAG,8,0),5,2)||'/'||LEFT(lpad(OD.DATVAG,8,0),4) DATACRIACAO ", NL," "\
				"       ,CASE WHEN TRIM(LE.CODCLI)='88315379000170' THEN CASE ", NL," "\
				"             WHEN TRIM(LE.CODTLI)='RP' THEN 'RP'  ELSE 'PED' END  ELSE CASE ", NL," "\
				"             WHEN TRIM(LE.CODCLI)<>'88315379000170' THEN 'NF'  ELSE 'ERRO' END END TIPODOCUMENTO ", NL," "\
				"       ,(SUBSTR(LE.REFLIV,1,LOCATE ('.',LE.REFLIV)-1)) NUMEROMOV ", NL," "\
				"       ,B.VALRUB SERIE ", NL," "\
				"       ,left(C.VALRUB,2)||'/'||substr(c.valrub,3,2)||'/'||right(trim(c.valrub),4) DATAEMISSAO ", NL," "\
				"       ,RIGHT(LE.DTILIV,2)||'/'||SUBSTR(LE.DTILIV,5,2)||'/'||LEFT(LE.DTILIV,4)||' '||LEFT(LPAD(LE.HEILIV,6,0),2)||':'||SUBSTR(LPAD(LE.HEILIV,6,0),3,2)||':'||'00' DATASAIDA ", NL," "\
				"       ,RIGHT(lpad(LE.MAJCRE,8,0),2)||'/'||substr(lpad(LE.MAJCRE,8,0),5,2)||'/'||LEFT(lpad(LE.MAJCRE,8,0),4)||' '||LEFT(LPAD(LE.HEUEXC,6,0),2)||':'||SUBSTR(LPAD(LE.HEUEXC,6,0),3,2)||':'||'00' DATAENTREGA ", NL," "\
				"       ,D.VALRUB VALORBRUTO ", NL," "\
				"       ,VLQ VALORLIQUIDO ", NL," "\
				"       ,CASE WHEN TRIM(LE.CODCLI)<>'88315379000170' THEN 'RETORNO SIMBOLICO'  ELSE 'RETORNO REAL' END OBSERVACAO ", NL," "\
				"       ,LE.TOULIV CAMPOLIVRE2 ", NL," "\
				"       ,H.PSL PESOLIQUIDO ", NL," "\
				"       ,CASE WHEN H.PSB<H.PSL THEN H.PSL  ELSE H.PSB END PESOBRUTO ", NL," "\
				"       ,F.VALRUB VOLUMES ", NL," "\
				"       ,LE.CRILIV CAMPOLIVRE3 ", NL," "\
				"       ,LE.CODTRA CNPJTRANSPORTADORA ", NL," "\
				"       ,(SUBSTR(LE.REFLIV,1,LOCATE ('.',LE.REFLIV)-1)) NUMERODELIVERY ", NL," "\
				"       ,RIGHT(LE.DTILIV,2)||'/'||SUBSTR(LE.DTILIV,5,2)||'/'||LEFT(LE.DTILIV,4)||' '||LEFT(LPAD(LE.HEILIV,6,0),2)||':'||SUBSTR(LPAD(LE.HEILIV,6,0),3,2)||':'||'00' DT_AGENDAMENTO ", NL," "\
				"       ,G.PRO CODIGOPRD ", NL," "\
				"       ,G.SRV QUANTIDADE ", NL," "\
				"       ,G.PRI PRECOUNITARIO ", NL," "\
				"       ,G.DS1 DESCRICAOPROD ", NL," "\
				"       ,G.NLILIV ", NL," "\
				"FROM FGE50FM",tToInfologPrefixFilename,".GELIVE LE ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEVAG OD ", NL," "\
				"ON LE.NUMVAG=OD.NUMVAG ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GELIRUB A ", NL," "\
				"ON LE.NUMLIV=A.NUMLIV AND A.CODRUB='NF01' ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GELIRUB B ", NL," "\
				"ON LE.NUMLIV=B.NUMLIV AND B.CODRUB='SE01' ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GELIRUB C ", NL," "\
				"ON LE.NUMLIV=C.NUMLIV AND C.CODRUB='DT01' ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GELIRUB D ", NL," "\
				"ON LE.NUMLIV=D.NUMLIV AND D.CODRUB='VL01' ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GELIRUB E ", NL," "\
				"ON LE.NUMLIV=E.NUMLIV AND E.CODRUB='PS01' ", NL," "\
				"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GELIRUB F ", NL," "\
				"ON LE.NUMLIV=F.NUMLIV AND F.CODRUB='VO01' ", NL," "\
				"LEFT JOIN ", NL," "\
				"( ", NL," "\
				"	SELECT  (SUBSTR(A.REFLIV,1,LOCATE ('.',A.REFLIV)-1)) REF ", NL," "\
				"	       ,A.CODPRO PRO ", NL," "\
				"	       ,A.DS1PRO DS1 ", NL," "\
				"	       ,SUM (A.UVCSRV) SRV ", NL," "\
				"	       ,CASE WHEN A.PRILIV=0 THEN B.VALRUB  ELSE A.PRILIV END PRI ", NL," "\
				"	       ,A.CODACT ACT ", NL," "\
				"	       ,A.NLILIV ", NL," "\
				"	FROM FGE50FM",tToInfologPrefixFilename,".GELIVD A, FGE50FM",tToInfologPrefixFilename,".GERILP B ", NL," "\
				"	WHERE A.REFLIV LIKE '",tREFLIVaConsiderar,"%' ", NL," "\
				"	AND A.NUMLIV=B.NUMLIV ", NL," "\
				"	AND A.NLILIV=B.NLILIV ", NL," "\
				"	GROUP BY  (SUBSTR(A.REFLIV,1,LOCATE ('.',A.REFLIV)-1)) ", NL," "\
				"	         ,A.CODPRO ", NL," "\
				"	         ,A.DS1PRO ", NL," "\
				"	         ,A.PRILIV ", NL," "\
				"	         ,A.CODACT ", NL," "\
				"	         ,A.NLILIV ", NL," "\
				"	         ,B.VALRUB ", NL," "\
				")G ", NL," "\
				"ON G.REF=(SUBSTR(LE.REFLIV, 1, LOCATE ('.', LE.REFLIV)-1)) AND G.ACT=LE.CODACT ", NL," "\
				"LEFT JOIN ", NL," "\
				"( ", NL," "\
				"	SELECT  REF ", NL," "\
				"	       ,SUM(PREC_UNIT*QTD) VLQ ", NL," "\
				"	       ,ACT ", NL," "\
				"	       ,SUM(PSL) PSL ", NL," "\
				"	       ,SUM(PSB) PSB ", NL," "\
				"	FROM ", NL," "\
				"	( ", NL," "\
				"		SELECT  (SUBSTR(A.REFLIV,1,LOCATE ('.',A.REFLIV)-1)) REF ", NL," "\
				"		       ,CASE WHEN A.PRILIV=0 THEN B.VALRUB  ELSE A.PRILIV END PREC_UNIT ", NL," "\
				"		       ,SUM(A.UVCSRV) QTD ", NL," "\
				"		       ,A.CODACT ACT ", NL," "\
				"		       ,A.NUMLIV ", NL," "\
				"		       ,SUM (A.UVCSRV*A.PDNUVC) PSL ", NL," "\
				"		       ,SUM ((A.UVCSRV/A.PCBPRO)*PDBCOL) PSB ", NL," "\
				"		FROM FGE50FM",tToInfologPrefixFilename,".GELIVD A, FGE50FM",tToInfologPrefixFilename,".GERILP B ", NL," "\
				"		WHERE A.REFLIV LIKE '",tREFLIVaConsiderar,"%' ", NL," "\
				"		AND A.NUMLIV=B.NUMLIV ", NL," "\
				"		AND A.NLILIV=B.NLILIV ", NL," "\
				"		GROUP BY  (SUBSTR(A.REFLIV,1,LOCATE ('.',A.REFLIV)-1)) ", NL," "\
				"		         ,A.CODACT ", NL," "\
				"		         ,A.PRILIV ", NL," "\
				"		         ,B.VALRUB ", NL," "\
				"		         ,A.NUMLIV ", NL," "\
				"	) ", NL," "\
				"	GROUP BY  REF ", NL," "\
				"	         ,ACT ", NL," "\
				") H ", NL," "\
				"ON H.REF=(SUBSTR(LE.REFLIV, 1, LOCATE ('.', LE.REFLIV)-1)) AND G.REF=H.REF AND H.ACT=LE.CODACT AND G.ACT=H.ACT ", NL," "\
				"WHERE LE.REFLIV LIKE '",tREFLIVaConsiderar,"%' ", NL," "\
				"AND OD.ETAVAG=30 ", NL," "\
				"GROUP BY  OD.DATVAG ", NL," "\
				"         ,LE.CODCLI ", NL," "\
				"         ,LE.CODTLI ", NL," "\
				"         ,(SUBSTR(LE.REFLIV,1,LOCATE ('.',LE.REFLIV)-1)) ", NL," "\
				"         ,B.VALRUB ", NL," "\
				"         ,C.VALRUB ", NL," "\
				"         ,LE.HEILIV ", NL," "\
				"         ,LE.DTILIV ", NL," "\
				"         ,LE.MAJCRE ", NL," "\
				"         ,LE.HEUEXC ", NL," "\
				"         ,D.VALRUB ", NL," "\
				"         ,G.NLILIV ", NL," "\
				"         ,H.VLQ ", NL," "\
				"         ,LE.TOULIV ", NL," "\
				"         ,H.PSL ", NL," "\
				"         ,H.PSB ", NL," "\
				"         ,F.VALRUB ", NL," "\
				"         ,LE.CRILIV ", NL," "\
				"         ,LE.CODTRA ", NL," "\
				"         ,G.PRO ", NL," "\
				"         ,G.SRV ", NL," "\
				"         ,G.PRI ", NL," "\
				"         ,G.DS1 ", NL," "\
				"ORDER BY 1")

				log("tQuery ",tQuery,NL)

				if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
					log("FATAL ", tfSqlErrorStr(),NL,tQuery)
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
					log("FATAL ", tfSqlErrorStr(),NL,tQuery)
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				bQueryTemResul := FALSE
				nContItemsQuery2 := 0
				tVAL_LIQQuery2 := "0"
				while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
					bQueryTemResul := TRUE
					nContItemsQuery2++
					tDATA_M97Query2 := peel(taDb2Array["DATACRIACAO"]," ")
					tTIPOQuery2 := peel(taDb2Array["TIPODOCUMENTO"]," ")
					tVAL_REFLIVQuery2 := peel(taDb2Array["NUMERODELIVERY"]," ")
					tVAL_SERIEQuery2 := peel(taDb2Array["SERIE"]," ")
					tDATA_CRIQuery2 := peel(taDb2Array["DATAENTREGA"]," ")
					tTOULIVQuery2 := peel(taDb2Array["CAMPOLIVRE2"]," ")
					tCRILIVQuery2 := peel(taDb2Array["CAMPOLIVRE3"]," ")
					tCODTRAQuery2 := peel(taDb2Array["CNPJTRANSPORTADORA"]," ")
					tDATA_AGEQuery2 := peel(taDb2Array["DT_AGENDAMENTO"]," ")
					tOBSERVQuery2 := peel(taDb2Array["OBSERVACAO"]," ")
					tVAL_BRUQuery2 := replace(build(number(peel(taDb2Array["VALORBRUTO"]," ")):R15.4),".",",")
					tVAL_LIQQuery2 := replace(build(number(peel(taDb2Array["VALORLIQUIDO"]," ")):R15.4),".",",") !build(number(peel(taDb2Array["VALORLIQUIDO"]," "))+number(tVAL_LIQQuery2))
					!replace(build(number(peel(taDb2Array["VAL_LIQ"]," ")):R15.4),".",",")
					taNLILIVQuery2[nContItemsQuery2] := peel(taDb2Array["NLILIV"]," ")
					taCODPROQuery2[nContItemsQuery2] := peel(taDb2Array["CODIGOPRD"]," ")
					taUVCSRVQuery2[nContItemsQuery2] := peel(taDb2Array["QUANTIDADE"]," ")
					taCODLOTQuery2[nContItemsQuery2] := peel(taDb2Array["CODLOT"]," ")
					taPR_UNTQuery2[nContItemsQuery2] := replace(build(number(peel(taDb2Array["PRECOUNITARIO"]," ")):R15.4),".",",")
					tDATA_EMIQuery2 := peel(taDb2Array["DATAEMISSAO"]," ")
					tREFLIVQuery2 := peel(taDb2Array["REFLIV"]," ")
					tPESOLIQUIDO := replace(peel(taDb2Array["PESOLIQUIDO"]," "),",",".")
					tPESOBRUTO := replace(peel(taDb2Array["PESOBRUTO"]," "),",",".")
					tVOLUMES := peel(taDb2Array["VOLUMES"]," ")
					remove(taDb2Array)
				endwhile

				if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
					log("FATAL ", tfSqlErrorStr(),NL,tQuery)
					bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
					exit(1)
				endif

				! ValidaÃ§Ã£o de duplicata
				split(tREFLIVaConsiderar,taREFLIVSplitado,".")
				TRACE := find(build(sHOME,"/trace"),NUMDOC=taREFLIVSplitado[1],MENSAGEM=build("CONFIRMACAO DE PEDIDO - TOTVS RM"),PERFIL="HARMAN",LIBEXC=tNUMVAG)
				bM97CONFSEPDuplicado := FALSE

				if valid(TRACE) then
					bM97CONFSEPDuplicado := TRUE
				endif

				! tQuery := build("SELECT VALRUB ", NL," "\
				! "FROM  FGE50FM",tToInfologPrefixFilename,".GELIRUB ", NL," "\
				! "WHERE NUMLIV IN ( ", NL," "\
				! "SELECT NUMLIV ", NL," "\
				! "FROM GELIVE ", NL," "\
				! "WHERE REFLIV LIKE '",tREFLIVaConsiderar,"%') ", NL," "\
				! "AND CODRUB = 'VL01'")

				! log("QUERY VALOR LIQ---------------------------------------------", NL)
				! log(tQuery, NL)
				! log("------------------------------------------------------------", NL)

				! if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
				! 	log("FATAL ", tfSqlErrorStr(),NL,tQuery)
				! 	bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				! 	exit(1)
				! endif

				! if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
				! 	log("FATAL ", tfSqlErrorStr(),NL,tQuery)
				! 	bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				! 	exit(1)
				! endif

				! while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
				! 	tVAL_BRUQuery2Temp := taDb2Array["VALRUB"]
				! 	remove(taDb2Array)
				! endwhile

				! if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
				! 	log("FATAL ", tfSqlErrorStr(),NL,tQuery)
				! 	bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
				! 	exit(1)
				! endif

				if bQueryTemResul = TRUE and bM97CONFSEPDuplicado = FALSE then
					R_HEADER_TIPO_REGISTRO("1")
					R_HEADER_ID("")
					R_HEADER_STATUS_INT("P")
					R_HEADER_DATACRIACAO(tDATA_M97Query2)
					R_HEADER_DTHRABSORCAO("")
					R_HEADER_TIPODOCUMENTO(tTIPOQuery2)
					R_HEADER_TIPO("S")
					R_HEADER_NUMEROMOV(tVAL_REFLIVQuery2)
					R_HEADER_CPFCNPJ(fmbrasil_clientesped.CNPJ) !ver codcli
					R_HEADER_NOME(fmbrasil_clientesped.NOME) !ver tabela codcli
					R_HEADER_RUA(fmbrasil_clientesped.RUA) !ver tabela codcli
					R_HEADER_NUMERO(fmbrasil_clientesped.NUMERO) !ver tabela codcli
					R_HEADER_COMPLEMENTO(fmbrasil_clientesped.COMPLEMENTO) !ver tabela codcli
					R_HEADER_BAIRRO(fmbrasil_clientesped.BAIRRO) !ver tabela codcli
					R_HEADER_CIDADE(fmbrasil_clientesped.CIDADE) !ver tabela codcli
					R_HEADER_CODETD(fmbrasil_clientesped.CODETD) !ver tabela codcli
					R_HEADER_CEP(fmbrasil_clientesped.CEP) !ver tabela codcli
					R_HEADER_TELEFONE(fmbrasil_clientesped.TELEFONE) !ver tabela codcli
					R_HEADER_EMAIL(fmbrasil_clientesped.EMAIL) !ver tabela codcli
					R_HEADER_CNPJFILIAL(build(number(fmbrasil_clientesped.CNPJFILIAL):R014)) !ver tabela codcli
					R_HEADER_SERIE(tVAL_SERIEQuery2)!tVALRUBSRNF
					R_HEADER_DATAEMISSAO(tDATA_EMIQuery2 )
					R_HEADER_DATASAIDA(tDATA_AGEQuery2 )
					R_HEADER_DATAENTREGA(tDATA_CRIQuery2)
					R_HEADER_VALORBRUTO(peel(tVAL_BRUQuery2," "))
					! if tVAL_BRUQuery2 = "0" then
					! 	R_HEADER_VALORLIQUIDO(peel(tVAL_BRUQuery2Temp," "))
					! else
					R_HEADER_VALORLIQUIDO(peel(tVAL_LIQQuery2," "))
					! endif
					R_HEADER_VALORFRETE("")
					R_HEADER_VALORDESPESAS("")
					R_HEADER_CAMPOLIVRE1(fmbrasil_clientesped.CODERP)
					R_HEADER_CAMPOLIVRE2(tTOULIVQuery2)

					tQuery := build("SELECT "\
							"CASE  "\
							"WHEN CODMOP='RET' THEN 'A' "\
							"WHEN CODMOP<>'RET' THEN 'M' "\
							"END ORIGEM "\
							"FROM FGE50FM",tToInfologPrefixFilename,".GELIVE "\
							"WHERE REFLIV LIKE '",tREFLIVaConsiderar,"%'")

					log("tQuery ",tQuery,NL)

					if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
						log("FATAL ", tfSqlErrorStr(),NL,tQuery)
						bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
						exit(1)
					endif

					if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
						log("FATAL ", tfSqlErrorStr(),NL,tQuery)
						bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
						exit(1)
					endif

					while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
						tORIGEMSelect := peel(taDb2Array["ORIGEM"]," ")
						remove(taDb2Array)
					endwhile

					if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
						log("FATAL ", tfSqlErrorStr(),NL,tQuery)
						bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
						exit(1)
					endif

					if length(tORIGEMSelect) > 0 then
						R_HEADER_ORIGEM(tORIGEMSelect)
					endif

					R_HEADER_OBSERVACAO(tOBSERVQuery2)
					tCont := peel(build(number(tPESOLIQUIDO)*1)," ")
					tCont := peel(build(number(tCont):R015)," ")
					R_HEADER_PESOLIQUIDO(replace(tCont,".",","))
					tCont := peel(build(number(tPESOBRUTO)*1)," ")
					tCont := peel(build(number(tCont):R015)," ")
					R_HEADER_PESOBRUTO(replace(tCont,".",","))
					R_HEADER_RECCREATEDBY("")
					R_HEADER_RECCREATEDON("")
					R_HEADER_RECMODIFIEDBY("")
					R_HEADER_RECMODIFIEDON("")
					R_HEADER_CAMPOLIVRE3(tCRILIVQuery2)
					R_HEADER_MOVGERADO("")
					R_HEADER_DADOSADICIONAIS("")
					R_HEADER_CNPJTRANSPORTADORA(tCODTRAQuery2)
					R_HEADER_IDNAT("")
					R_HEADER_CODTRA("")
					R_HEADER_PESSOAFISOUJUR("")
					R_HEADER_CONTRIBUINTE("")
					R_HEADER_REGIMEESPECIAL("")
					R_HEADER_INSCRESTADUAL(fmbrasil_clientesped.INSCRESTADUAL) !ver tabela codcli
					R_HEADER_FRETECIFOUFOB("")
					R_HEADER_ESPECIE("")  !adicionar aqui a especie de volumes
					R_HEADER_VOLUMES("") !adicionar aqui a quantidade de paletes
					R_HEADER_NUMERODELIVERY(build(tVAL_REFLIVQuery2,".",tVAL_SERIEQuery2))
					R_HEADER_CONSUMIDORFINAL("")
					R_HEADER_VALORICMS("")
					R_HEADER_BASEICMS("")
					R_HEADER_BASEICMSST("")
					R_HEADER_VALORICMSST("")
					R_HEADER_DT_AGENDAMENTO(tDATA_AGEQuery2)
					R_HEADER_CFV_COD("")
					R_HEADER_IDESTRANGEIRO("")
					R_HEADER_CODTDO("NFE")
					R_HEADER_UFDESEMBARACO("")
					R_HEADER_LOCALDESEMBARACO("")

					print(taHEADER[1],";",taHEADER[2],";",taHEADER[3],";",taHEADER[4],";",taHEADER[5],";",taHEADER[6],";",taHEADER[7],";",taHEADER[8],";",taHEADER[9],";",taHEADER[10],";",taHEADER[11],";",taHEADER[12], \
						";",taHEADER[13],";",taHEADER[14],";",taHEADER[15],";",taHEADER[ \
						16],";",taHEADER[17],";",taHEADER[18],";",taHEADER[19],";", \
						taHEADER[20],";",taHEADER[21],";",taHEADER[22],";",taHEADER[23],";" \
						,taHEADER[24],";",taHEADER[25],";",taHEADER[26],";",taHEADER[27], \
						";",taHEADER[28],";",taHEADER[29],";",taHEADER[30],";",taHEADER[ \
						31],";",taHEADER[32],";",taHEADER[33],";",taHEADER[34],";", \
						taHEADER[35],";",taHEADER[36],";",taHEADER[37],";",taHEADER[38],";" \
						,taHEADER[39],";",taHEADER[40],";",taHEADER[41],";",taHEADER[42], \
						";",taHEADER[43],";",taHEADER[44],";",taHEADER[45],";",taHEADER[ \
						46],";",taHEADER[47],";",taHEADER[48],";",taHEADER[49],";", \
						taHEADER[50],";",taHEADER[51],";",taHEADER[52],";",taHEADER[53],";",taHEADER[54],";",taHEADER[55],";",taHEADER[56],";",taHEADER[57], \
						";",taHEADER[58],";",taHEADER[59],";",taHEADER[60],";",taHEADER[ \
						61],";",taHEADER[62],";",taHEADER[63], NL)   >> tFileOutTempPED
					remove(taHEADER)

					!executa para o resto do processo
					nTempINDContadorSup5130 := 1
					while nTempINDContadorSup5130 <= nContItemsQuery2 do
						R_DETAIL_TIPO_REGISTRO("2")
						R_DETAIL_ID("")
						nContador5120PED++
						R_DETAIL_NUMEROSEQUENCIAL(build(nTempINDContadorSup5130))
						if number(taCODPROQuery2[nTempINDContadorSup5130]) <> 0 then
							R_DETAIL_CODIGOPRD(build(number(taCODPROQuery2[nTempINDContadorSup5130])))
						else
							R_DETAIL_CODIGOPRD(taCODPROQuery2[nTempINDContadorSup5130])
						endif
						R_DETAIL_QUANTIDADE(taUVCSRVQuery2[nTempINDContadorSup5130])
						!tCont := peel(build(number(taPR_UNTQuery2[nTempINDContadorSup5130]):R015)," ")

						! tQuery := build("SELECT VALRUB ", NL," "\
						! 				"FROM  FGE50FM",tToInfologPrefixFilename,".GERILP ", NL," "\
						! 				"WHERE NUMLIV IN ( ", NL," "\
						! 				"SELECT NUMLIV ", NL," "\
						! 				"FROM GELIVE ", NL," "\
						! 				"WHERE REFLIV LIKE '",tREFLIVaConsiderar,"%') ", NL," "\
						! 				"AND NLILIV = '",taNLILIVQuery2[nTempINDContadorSup5130],"'")
						
                        ! log("QUERY PRECO UNI---------------------------------------------", NL)
                        ! log(tQuery, NL)
                        ! log("------------------------------------------------------------", NL)

						! if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
						! 	log("FATAL ", tfSqlErrorStr(),NL,tQuery)
						! 	bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
						! 	exit(1)
						! endif

						! if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
						! 	log("FATAL ", tfSqlErrorStr(),NL,tQuery)
						! 	bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
						! 	exit(1)
						! endif

						! while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
						! 	taPR_UNTQuery2Temp[nTempINDContadorSup5130] := replace(taDb2Array["VALRUB"],".",",")
						! 	log("taPR_UNTQuery2Temp[",nTempINDContadorSup5130,"] = ",taPR_UNTQuery2Temp[nTempINDContadorSup5130],NL)
						! 	remove(taDb2Array)
						! endwhile

						! if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
						! 	log("FATAL ", tfSqlErrorStr(),NL,tQuery)
						! 	bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
						! 	exit(1)
						! endif

						! if length(taPR_UNTQuery2Temp[nTempINDContadorSup5130]) > 0 then
						! 	R_DETAIL_PRECOUNITARIO(peel(taPR_UNTQuery2Temp[nTempINDContadorSup5130]," "))
						! else
						R_DETAIL_PRECOUNITARIO(peel(taPR_UNTQuery2[nTempINDContadorSup5130]," "))
						! endif

						tDS1PRO1Select := ""

						tQuery := build("SELECT DS1PRO FROM FGE50FM",tToInfologPrefixFilename,".GEPRO WHERE CODPRO = '",build(number(taCODPROQuery2[nTempINDContadorSup5130])),"'")
						log("tQuery ",tQuery,NL)

						if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
							log("FATAL ", tfSqlErrorStr(),NL,tQuery)
							bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
							exit(1)
						endif

						if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
							log("FATAL ", tfSqlErrorStr(),NL,tQuery)
							bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
							exit(1)
						endif

						while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
							tDS1PRO1Select := peel(taDb2Array["DS1PRO"]," ")
							remove(taDb2Array)
						endwhile

						if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
							log("FATAL ", tfSqlErrorStr(),NL,tQuery)
							bfMajtracePED("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
							exit(1)
						endif

						R_DETAIL_DESCRICAOPROD(tDS1PRO1Select) !por resultado select
						R_DETAIL_UND("UN")
						R_DETAIL_CODFABRICANTE(fmbrasil_clientesped.CODIGOFABRICANTE) !ver tabela codcli
						R_DETAIL_IDLOTE("")
						R_DETAIL_RECCREATEDBY("")
						R_DETAIL_RECCREATEDON("")
						R_DETAIL_RECMODIFIEDBY("")
						R_DETAIL_RECMODIFIEDON("")
						R_DETAIL_CODIGOBARRAS("")
						R_DETAIL_CODIFFISCAL("")
						R_DETAIL_PROCMERCADORIA("")
						R_DETAIL_NRREFERENCIA("")
						R_DETAIL_SERIE("")
						R_DETAIL_IDNAT("")
						R_DETAIL_CODCOLIGADA("")
						R_DETAIL_QTDFALTA("")
						R_DETAIL_TIPOPRD("")
						R_DETAIL_USOECONSUMO("")
						R_DETAIL_NUMEROCCF("")
						R_DETAIL_ALIQICMS("")
						R_DETAIL_VALORICMS("")
						R_DETAIL_BASEICMS("")
						R_DETAIL_ALIQICMSST("")
						R_DETAIL_BASEICMSST("")
						R_DETAIL_VALORICMSST("")
						R_DETAIL_ALIQIVA("")
						R_DETAIL_CODIGOCEST("")

						print(taDETAIL[1],";",taDETAIL[2],";",taDETAIL[3],";",taDETAIL[4],";",taDETAIL[5],";",taDETAIL[6],";",taDETAIL[7],";",taDETAIL[8],";",taDETAIL[9],";",taDETAIL[10],";",taDETAIL[11],";",taDETAIL[12], \
							";",taDETAIL[13],";",taDETAIL[14],";",taDETAIL[15],";",taDETAIL[ \
							16],";",taDETAIL[17],";",taDETAIL[18],";",taDETAIL[19],";", \
							taDETAIL[20],";",taDETAIL[21],";",taDETAIL[22],";",taDETAIL[23],";",taDETAIL[24],";",taDETAIL[25],";",taDETAIL[26],";",taDETAIL[27], \
							";",taDETAIL[28],";",taDETAIL[29],";",taDETAIL[30],";",taDETAIL[ \
							31],";",taDETAIL[32],";",taDETAIL[33],";",taDETAIL[34], NL) >> tFileOutTempPED
						remove(taDETAIL)

						nTempINDContadorSup5130++
					endwhile
					bfMajtracePED("Recebida","0",build(tNumeroPedido),tDataDocumento,tFileInput,tFileOut,"Produtos","")
					close(tFileOutTempPED)
					copy(tFileOutTempPED,tFileOutPED)
					close(tFileOutTempPED)
					remove(tFileOutTempPED)
					close(tFileOutPED)
				endif
			endif
		endif
	endif













	if S_GEEX9750_ETALIV = "30" then
			tPickingStaDate := S_GEEX9750_DATEXC
			tPickingStaTime := S_GEEX9750_HEUEXC
			bGeraArquivo := TRUE
			!tMensagemTrace := "INICIO PICKING"
			tREFLIV := S_GEEX9750_REFLIV
			tNUMLIV := S_GEEX9750_NUMLIV
		 tNUMVAG := S_GEEX9750_NUMVAG

		TRACE := find(build(sHOME,"/trace"),NUMDOC=tREFLIVaConsiderar,MENSAGEM=build("M97 - UPDATE"),PERFIL="HARMAN",LIBEXC=tNUMVAG)
		if valid(TRACE) then
						bGeraArquivo := FALSE
		endif


		 if bGeraArquivo = TRUE then


			/*


				tQuery := build("SELECT SD.NUMSUP  "\
				",SE.TYPSUP  "\
				",SD.SEQSUP  "\
				",SE.CIRPIC  "\
				",SD.CODPRO  "\
				",SD.UVCSRV  "\
				",SD.UVCLIV  "\
				",SD.PCBPRO  "\
				",SD.PRPPIC  "\
				",CASE  "\
				"WHEN SD.PRPPIC=5 THEN CEILING(BANC.VOL)  "\
				"ELSE (SD.UVCSRV/SD.PCBPRO)  "\
				"END VOLUMES  "\
				",TRIM(SD.MSGLIG) MSGLIG  "\
				",TRIM(SD.DIPLIV) DIPLIV  "\
				"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE  "\
				", FGE50FM",tToInfologPrefixFilename,".GESUPD SD  "\
				", FGE50FM",tToInfologPrefixFilename,".GEPRO PD  "\
				", (  "\
				"SELECT (SUM(UVCSRV/PCBPRO)) VOL  "\
				"FROM FGE50FM",tToInfologPrefixFilename,".GESUPD  "\
				"WHERE NUMLIV='",tNUMLIV,"'  "\
				") BANC  "\
				"WHERE SE.NUMSUP=SD.NUMSUP  "\
				"AND SE.CODACT=SD.CODACT  "\
				"AND SD.CODPRO=PD.CODPRO  "\
				"AND SD.CODACT=PD.CODACT  "\
				"AND SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
				"AND SE.TYPSUP<>3  "\
				"GROUP BY SD.NUMSUP  "\
				",SE.TYPSUP  "\
				",SD.SEQSUP  "\
				",SE.CIRPIC  "\
				",SD.CODPRO  "\
				",SD.UVCSRV  "\
				",SD.UVCLIV  "\
				",SD.PCBPRO  "\
				",SD.MSGLIG  "\
				",SD.DIPLIV  "\
				",SD.PRPPIC  "\
				",BANC.VOL  "\
				"ORDER BY SE.TYPSUP DESC  "\
				", SD.NUMSUP ASC  "\
				", SD.SEQSUP ASC")


				tQuery := build("SELECT SD.NUMSUP "\
",SE.TYPSUP "\
",SD.SEQSUP "\
",SE.CIRPIC "\
",SD.CODPRO "\
",SD.UVCSRV "\
",SD.UVCLIV "\
",SD.PCBPRO "\
",SD.PRPPIC "\
",CASE "\
"WHEN SD.PRPPIC=5 THEN INTEGER(CEILING(SD.UVCSRV/SD.PCBPRO)) "\
"ELSE INTEGER(SD.UVCSRV/SD.PCBPRO) "\
"END VOLUMES "\
",TRIM(SE.CODMOP) CODMOP "\
",TRIM(SD.DIPLIV) DIPLIV "\
"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
", FGE50FM",tToInfologPrefixFilename,".GESUPD SD "\
", FGE50FM",tToInfologPrefixFilename,".GEPRO PD "\
"WHERE SE.NUMSUP=SD.NUMSUP "\
"AND SE.CODACT=SD.CODACT "\
"AND SD.CODPRO=PD.CODPRO "\
"AND SD.CODACT=PD.CODACT "\
"AND SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
"AND SE.TYPSUP<>3 "\
"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
"GROUP BY SD.NUMSUP "\
",SE.TYPSUP "\
",SD.SEQSUP "\
",SE.CIRPIC "\
",SD.CODPRO "\
",SD.UVCSRV "\
",SD.UVCLIV "\
",SD.PCBPRO "\
",SE.CODMOP "\
",SD.DIPLIV "\
",SD.PRPPIC "\
"ORDER BY SE.TYPSUP DESC "\
", SD.NUMSUP ASC "\
", SD.SEQSUP ASC")

*/

				tQuery := build("SELECT SD.NUMSUP "\
",SE.TYPSUP  "\
",SD.SEQSUP "\
",SE.CIRPIC "\
",SD.CODPRO "\
",SD.UVCSRV "\
",SD.UVCLIV "\
",SD.PCBPRO "\
",SD.PRPPIC "\
",CASE "\
"WHEN SD.PRPPIC=5 THEN INTEGER(CEILING(SD.UVCSRV/SD.PCBPRO)) "\
"ELSE INTEGER(SD.UVCSRV/SD.PCBPRO) "\
"END VOLUMES "\
",TRIM(SE.CODMOP) CODMOP "\
",TRIM(SD.DIPLIV) DIPLIV "\
",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF "\
",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 2) SNF "\
",SUM(SD.UVCSRV) as SOMAUVCSRV "\
"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
", FGE50FM",tToInfologPrefixFilename,".GESUPD SD "\
", FGE50FM",tToInfologPrefixFilename,".GEPRO PD "\
"WHERE SE.NUMSUP=SD.NUMSUP "\
"AND SE.CODACT=SD.CODACT "\
"AND SD.CODPRO=PD.CODPRO "\
"AND SD.CODACT=PD.CODACT "\
"AND SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
"AND SE.TYPSUP<>3 "\
"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
"GROUP BY SD.NUMSUP "\
",SE.TYPSUP "\
",SD.SEQSUP "\
",SE.CIRPIC "\
",SD.CODPRO "\
",SD.UVCSRV "\
",SD.UVCLIV "\
",SD.PCBPRO "\
",SE.CODMOP "\
",SD.DIPLIV "\
",SD.PRPPIC "\
",SE.REFLIV "\
"ORDER BY SE.TYPSUP DESC "\
", SD.NUMSUP ASC "\
", SD.SEQSUP ASC")


				log(tQuery,NL)


						if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
									 print("FATAL ", tfSqlErrorStr())
									 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
									exit(1)

						endif

						if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
							 print("FATAL ", tfSqlErrorStr())
							  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
									exit(1)

						endif

						tVOLUMES    := ""
						nContadorResultadosQuery := 0
						!bFazupdade2 := FALSE
						!fara sempre select 2 e update 2
						bFazupdade2 := TRUE
						bJaTemPRPPICIgualCinco := FALSE
						!bFezPRPPICIguaLCinco  := FALSE

						/*
						Se PRPPIC=5 e SUM(UVCSRV)<PCBPRO entÃ£o preencher somente para a primeira linha PRPPIC=5;
						Se PRPPIC=5 e SUM(UVCSRV)>PCBPRO entÃ£o realizar tratativa normal

						*/

						while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
							nContadorResultadosQuery++

							if nContadorResultadosQuery = 1 then
								if peel(taDb2Array["CODMOP"]," ") = "VEN" or peel(taDb2Array["CODMOP"]," ") = "MAS" then
									log("faz select 2 e update 2 porque codmop = ",peel(taDb2Array["CODMOP"]," "),NL)
									bFazupdade2 := TRUE

								endif
							endif
							if bFazupdade2 = FALSE then

								log("SOMAUVCSRV ",peel(taDb2Array["SOMAUVCSRV"]," "),NL)
								log("PCBPRO ",peel(taDb2Array["PCBPRO"]," "),NL)
								taSOMAUVCSRV[nContadorResultadosQuery] := peel(taDb2Array["SOMAUVCSRV"]," ")
								taPCBPRO[nContadorResultadosQuery] := peel(taDb2Array["PCBPRO"]," ")
								taVOLUMESAux[nContadorResultadosQuery] := peel(taDb2Array["VOLUMES"]," ")
								taMSGLIGOriginal[nContadorResultadosQuery] := peel(taDb2Array["MSGLIG"]," ")
								split(taMSGLIGOriginal[nContadorResultadosQuery],taDIPLIVCalculadoSplitado,"/")
								taDIPLIVCalculado[nContadorResultadosQuery] := peel(taDb2Array["DIPLIV"]," ")
								taPRPPIC[nContadorResultadosQuery] := peel(taDb2Array["PRPPIC"]," ")
								if substr(peel(taDb2Array["SNF"]," "),2,1) = "1" or substr(peel(taDb2Array["SNF"]," "),2,1) = "2" or substr(peel(taDb2Array["SNF"]," "),2,1) = "3" or substr(peel(taDb2Array["SNF"]," "),2,1) = "4" or substr(peel(taDb2Array["SNF"]," "),2,1) = "5" or substr(peel(taDb2Array["SNF"]," "),2,1) = "6" or substr(peel(taDb2Array["SNF"]," "),2,1) = "7" or substr(peel(taDb2Array["SNF"]," "),2,1) = "8" or substr(peel(taDb2Array["SNF"]," "),2,1) = "9" or substr(peel(taDb2Array["SNF"]," "),2,1) = "0" then
									taSNF[nContadorResultadosQuery] := peel(taDb2Array["SNF"]," ")
								else
									taSNF[nContadorResultadosQuery] := substr(peel(taDb2Array["SNF"]," "),1,1)
								endif

								if taPRPPIC[nContadorResultadosQuery] = "5"  then
									if bJaTemPRPPICIgualCinco = FALSE then
										bJaTemPRPPICIgualCinco := TRUE
										if nContadorResultadosQuery = 1 then
											taVOLUMES[nContadorResultadosQuery] := "1"
										else
											taVOLUMES[nContadorResultadosQuery] := build(number(taVOLUMES[nContadorResultadosQuery-1])+number(taVOLUMESAux[nContadorResultadosQuery-1]))
										endif
									else
										taVOLUMES[nContadorResultadosQuery] := build(number(taVOLUMES[nContadorResultadosQuery-1]))

									endif

								else
									if nContadorResultadosQuery = 1 then
										taVOLUMES[nContadorResultadosQuery] := "1"
									else
										taVOLUMES[nContadorResultadosQuery] := build(number(taVOLUMES[nContadorResultadosQuery-1])+number(taVOLUMESAux[nContadorResultadosQuery-1]))
									endif
								endif

								!fazer update

								!if taPRPPIC[nContadorResultadosQuery] = "5" and number(taSOMAUVCSRV[nContadorResultadosQuery]) < number(taPCBPRO[nContadorResultadosQuery]) and bFezPRPPICIguaLCinco  = TRUE then
									! nao faz nada
								!	log("nao faz update do msglig por PRPPIC = 5 e SUM(UVCSRV) ", taSOMAUVCSRV[nContadorResultadosQuery], " < PCBPRO ",taPCBPRO[nContadorResultadosQuery], " feito mais que uma vez!",NL)
								!else
								!	if taPRPPIC[nContadorResultadosQuery] = "5" and number(taSOMAUVCSRV[nContadorResultadosQuery]) < number(taPCBPRO[nContadorResultadosQuery]) and bFezPRPPICIguaLCinco  = FALSE then
								!		bFezPRPPICIguaLCinco  := TRUE
								!	endif

									taQueryUpdade[nContadorResultadosQuery] := build("UPDATE FGE50FM",tToInfologPrefixFilename,".GESUPD "\
										"SET MSGLIG='",build(number(taVOLUMES[nContadorResultadosQuery]):R05),"/",build(number(taVOLUMESAux[nContadorResultadosQuery]):R05),"/",build(number(peel(taDb2Array["DIPLIV"]," ")):R05),"/",build(number(peel(taDb2Array["NF"]," ")):R06),"/",build(number(taSNF[nContadorResultadosQuery]):R03),"'  "\
										"WHERE NUMSUP='",peel(taDb2Array["NUMSUP"]," "),"' "\
										"AND SEQSUP='",peel(taDb2Array["SEQSUP"]," "),"' "\
										"AND CODPRO='",peel(taDb2Array["CODPRO"]," "),"' "\
										"AND UVCSRV='",peel(taDb2Array["UVCSRV"]," "),"' WITH NONE")


									log(taQueryUpdade[nContadorResultadosQuery],NL)


									!colocar aqui o update


											if not bfSqlSet(tDbBase2, "Updatedb2", taQueryUpdade[nContadorResultadosQuery]) then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("1 - Erro na execucao da query ",taQueryUpdade[nContadorResultadosQuery]," do banco de dados: ",tfSqlErrorStr()))
											  exit(27)
										   endif
										   if not bfSqlExec(tDbBase2, "Updatedb2") then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("2 - Erro na execucao da query ",taQueryUpdade[nContadorResultadosQuery]," do banco de dados: ",tfSqlErrorStr()))
											  exit(28)
										   endif
										   if not bfSqlCommit(tDbBase2, "Updatedb2") then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("3 - Erro na execucao da query ",taQueryUpdade[nContadorResultadosQuery]," do banco de dados: ",tfSqlErrorStr()))
											  exit(29)
										   endif
										   if not bfSqlFree(tDbBase2, "Updatedb2") then
											  log(tfSqlErrorStr(), NL)
											  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("4 - Erro na execucao da query ",taQueryUpdade[nContadorResultadosQuery]," do banco de dados: ",tfSqlErrorStr()))
											  exit(30)
										   endif

								!endif

							endif

							remove(taDb2Array)

						endwhile



						if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
							print("FATAL", tfSqlErrorStr())
							 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
									exit(1)
						endif






						if nContadorResultadosQuery > 0 and bFazupdade2 = FALSE then
							bfMajtraceUPDATE("Recebida","0",build(tPlacaVeiculo,"-",tRomaneio),tDataDocumento,tFileInput,tFileOut,"Produtos","")
						endif





						!select e update 2
						if bFazupdade2 = TRUE then


										tQuery := build("SELECT SEQSUP, CODPRO FROM FGE50FM",tToInfologPrefixFilename,".GESUPD WHERE REFLIV LIKE '",tREFLIVaConsiderar,"%' ORDER BY SEQSUP ASC")

										!SELECT A.numsup, B.typsup, A.SEQSUP, A.CODPRO FROM FGE50FM",tToInfologPrefixFilename,".GESUPD A, FGE50FM",tToInfologPrefixFilename,".GESUPE B WHERE A.NUMLIV=B.NUMLIV AND A.NUMSUP=B.NUMSUP AND A.NUMLIV='",tNUMLIV,"' ORDER BY A.SEQSUP ASC
										tQuery := build("SELECT A.numsup, B.typsup, A.SEQSUP, A.CODPRO FROM FGE50FM",tToInfologPrefixFilename,".GESUPD A, FGE50FM",tToInfologPrefixFilename,".GESUPE B WHERE A.NUMLIV=B.NUMLIV AND A.NUMSUP=B.NUMSUP AND A.REFLIV LIKE '",tREFLIVaConsiderar,"%' ORDER BY A.SEQSUP ASC,B.TYPSUP DESC")
										tQuery := build("SELECT A.numsup, B.typsup,A.PRPPIC, A.SEQSUP, A.CODPRO FROM FGE50FM",tToInfologPrefixFilename,".GESUPD A, FGE50FM",tToInfologPrefixFilename,".GESUPE B WHERE A.NUMLIV=B.NUMLIV AND A.NUMSUP=B.NUMSUP AND A.REFLIV LIKE '",tREFLIVaConsiderar,"%' ORDER BY A.PRPPIC ASC,A.numsup ,  A.SEQSUP ASC,B.TYPSUP DESC")
										log(tQuery,NL)


												if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
															 print("FATAL ", tfSqlErrorStr())
															 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
															exit(1)

												endif

												if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
													 print("FATAL ", tfSqlErrorStr())
													  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
															exit(1)

												endif


												nContadorResultadosQuery2_1 := 0



												while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
													nContadorResultadosQuery2_1++

													taSEQSUPQuery2_1[nContadorResultadosQuery2_1] := peel(taDb2Array["SEQSUP"]," ")
													taCODPROQuery2_1[nContadorResultadosQuery2_1] := peel(taDb2Array["CODPRO"]," ")
													taTYPSUPQuery2_1[nContadorResultadosQuery2_1] := peel(taDb2Array["TYPSUP"]," ")
													baDUPLICADOCODPROQuery2_1[nContadorResultadosQuery2_1] := FALSE
													remove(taDb2Array)

												endwhile



												if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
													print("FATAL", tfSqlErrorStr())
													 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
															exit(1)
												endif




										!colocar validaÃ§Ã£o de duplicados por codpro

										nTempContadorResultadosQuery2_1 := 1
										while nTempContadorResultadosQuery2_1 <= nContadorResultadosQuery2_1 do
											nTempContadorResultadoVAl2 := nTempContadorResultadosQuery2_1+1
											while nTempContadorResultadoVAl2 <= nContadorResultadosQuery2_1 do
												if taCODPROQuery2_1[nTempContadorResultadoVAl2] = taCODPROQuery2_1[nTempContadorResultadosQuery2_1] and taTYPSUPQuery2_1[nTempContadorResultadoVAl2] = taTYPSUPQuery2_1[nTempContadorResultadosQuery2_1] then
													baDUPLICADOCODPROQuery2_1[nTempContadorResultadoVAl2] := TRUE
												endif
												nTempContadorResultadoVAl2++
											endwhile
											nTempContadorResultadosQuery2_1++
										endwhile




										!depois a 2Âª query

										nContadorResultadosQuery2_2 := 0

										nTempContadorResultadosQuery2_1 := 1
										while nTempContadorResultadosQuery2_1 <= nContadorResultadosQuery2_1 do
											if baDUPLICADOCODPROQuery2_1[nTempContadorResultadosQuery2_1] = FALSE then
												if taTYPSUPQuery2_1[nTempContadorResultadosQuery2_1] = "2" then
															tQuery := build("SELECT SD.NUMSUP  "\
															",SE.TYPSUP   "\
															",SE.CIRPIC  "\
															",SD.CODPRO  "\
															",SUM(SD.UVCSRV) UVCSRV "\
															",SUM(SD.UVCLIV) UVCLIV "\
															",SD.PCBPRO  "\
															",INTEGER(CEILING(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
															",TRIM(SE.CODMOP) CODMOP  "\
															",TRIM(SD.DIPLIV) DIPLIV  "\
															",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
															",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
															",SUM(SD.UVCSRV) as SOMAUVCSRV  "\
															"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE  "\
															", FGE50FM",tToInfologPrefixFilename,".GESUPD SD  "\
															", FGE50FM",tToInfologPrefixFilename,".GEPRO PD  "\
															"WHERE SE.NUMSUP=SD.NUMSUP  "\
															"AND SE.CODACT=SD.CODACT  "\
															"AND SD.CODPRO=PD.CODPRO  "\
															"AND SD.CODACT=PD.CODACT  "\
															"AND SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'   "\
															"AND SE.TYPSUP<>3  "\
															"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
															"AND SD.UVCSRV<>0 "\
															"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"' "\
															"GROUP BY SD.NUMSUP  "\
															",SE.TYPSUP  "\
															",SE.CIRPIC  "\
															",SD.CODPRO  "\
															",SD.PCBPRO  "\
															",SE.CODMOP  "\
															",SD.DIPLIV  "\
															",SE.REFLIV  "\
															"ORDER BY SE.TYPSUP DESC  "\
															", SD.NUMSUP ASC")
															
															
															
															
															!primeiro typesup = 2
															
															tQuery := build("SELECT SD.NUMSUP  "\
																		"	,SE.TYPSUP   "\
																		"	,SE.CIRPIC  "\
																		"	,SD.CODPRO "\
																		"	,QR.NUMSUP SUP_MASSIF "\
																		"	,SD.CPTMAS "\
																		"	,SUM(SD.UVCSRV) UVCSRV "\
																		"	,SUM(SD.UVCLIV) UVCLIV "\
																		"	,SD.PCBPRO  "\
																		"	,INTEGER(CEILING(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																		"	,TRIM(SE.CODMOP) CODMOP  "\
																		"	,TRIM(SD.DIPLIV) DIPLIV  "\
																		"	,LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																		"	,SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																		"	,SUM(SD.UVCSRV) as SOMAUVCSRV "\
																		"	FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																		"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																		"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																		"	LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR ON SD.CPTMAS=QR.CPTMAS AND SD.CODACT=QR.CODACT AND SD.CODPRO=QR.CODPRO "\
																		"	WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																		"	AND SE.TYPSUP<>3  "\
																		"	AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																		"	AND SD.UVCSRV<>0 "\
																		"   AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'  "\
																		"   AND SE.TYPSUP=2  "\
																		"	GROUP BY SD.NUMSUP "\
																		"	, SE.CODMOP "\
																		"	,SD.CPTMAS "\
																		"	,QR.NUMSUP "\
																		"	,SE.TYPSUP  "\
																		"	,SE.CIRPIC  "\
																		"	,SD.CODPRO   "\
																		"	,SD.PCBPRO   "\
																		"	,SD.DIPLIV   "\
																		"	,SE.REFLIV  "\
																		"	ORDER BY SE.TYPSUP DESC   "\
																		"	, SD.NUMSUP ASC  "\
																		"	, SD.CODPRO,QR.NUMSUP ")
																		
																		
																		
																		
																		
																		
																		
																		tQuery := build("SELECT SD.NUMSUP  "\
																					"	,SE.TYPSUP   "\
																					"	,SE.CIRPIC  "\
																					"	,TRIM(SD.CODPRO) CODPRO "\
																					"	,QR1.NUMSUP SUP_MASSIF "\
																					"	,SD.CPTMAS "\
																					"	,SUM(SD.UVCSRV) UVCSRV "\
																					"	,SUM(SD.UVCLIV) UVCLIV "\
																					"	,QR2.TOT_CX_PROD_NF "\
																					"	,SD.PCBPRO  "\
																					"	,INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					"	,TRIM(SE.CODMOP) CODMOP  "\
																					"	,TRIM(SD.DIPLIV) DIPLIV  "\
																					"	,LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					"	,SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					"	,SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"	FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"	LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"	LEFT JOIN (SELECT NUMLIV, CODPRO, SUM(CEILING(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO) QR2 ON SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV "\
																					"	WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																					"	AND SE.TYPSUP<>3  "\
																					"	AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"	AND SD.UVCSRV<>0 "\
																					"   AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'  "\
																					"   AND SE.TYPSUP=2  "\
																					"	GROUP BY SD.NUMSUP "\
																					"	, SE.CODMOP "\
																					"	,SD.CPTMAS "\
																					"	,QR1.NUMSUP "\
																					"	,QR2.TOT_CX_PROD_NF "\
																					"	,SE.TYPSUP  "\
																					"	,SE.CIRPIC  "\
																					"	,SD.CODPRO  "\
																					"	,SD.PCBPRO  "\
																					"	,SD.DIPLIV  "\
																					"	,SE.REFLIV "\
																					"	ORDER BY SE.TYPSUP DESC "\
																					"	, SD.NUMSUP ASC"\
																					"	, SD.CODPRO ")
																		
																		
																		tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP   "\
																					",SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, CODPRO, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO) QR2 ON SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'  "\
																					"AND SE.TYPSUP=2  "\
																					"GROUP BY SD.NUMSUP "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY SE.TYPSUP DESC  "\
																					", SD.NUMSUP ASC "\
																					", SD.CODPRO ")
																		
																		
																		tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP   "\
																					",SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, CODPRO, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO) QR2 ON SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'   "\
																					"AND SE.TYPSUP=2   "\
																					"GROUP BY SD.NUMSUP "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY SE.TYPSUP DESC "\
																					", SD.NUMSUP ASC"\
																					", SD.CODPRO ")
																					
																					
																					tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP   "\
																					",SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, CODPRO, cptmas, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO, cptmas) QR2 ON SD.CPTMAS=QR2.CPTMAS AND SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV  "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'    "\
																					"AND SE.TYPSUP=2    "\
																					"GROUP BY SD.NUMSUP "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY SE.TYPSUP DESC  "\
																					", SD.NUMSUP ASC "\
																					", SD.CODPRO")
																					
																					
																					tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP   "\
																					", SD.PRPPIC "\
																					",SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 2) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, NUMSUP,CODPRO, cptmas, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO, cptmas, NUMSUP) QR2 ON SD.CPTMAS=QR2.CPTMAS AND SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV AND SD.NUMSUP=QR2.NUMSUP "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'   "\
																					"AND SE.TYPSUP=2    "\
																					"GROUP BY SD.NUMSUP , SD.PRPPIC "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY  SD.PRPPIC ASC, SE.TYPSUP DESC  "\
																					", SD.NUMSUP ASC "\
																					", SD.CODPRO")
																		
																		


															log(tQuery,NL)


																	if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
																				 print("FATAL ", tfSqlErrorStr())
																				 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																				exit(1)

																	endif

																	if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
																		 print("FATAL ", tfSqlErrorStr())
																		  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																				exit(1)

																	endif


												
												



																	while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
																		nContadorResultadosQuery2_2++
																		log("SOMAUVCSRV ",peel(taDb2Array["SOMAUVCSRV"]," "),NL)
																		log("PCBPRO ",peel(taDb2Array["PCBPRO"]," "),NL)
																		taTYPSUP[nContadorResultadosQuery2_2] := peel(taDb2Array["TYPSUP"]," ")
																		taSOMAUVCSRV[nContadorResultadosQuery2_2] := peel(taDb2Array["SOMAUVCSRV"]," ")
																		taPCBPRO[nContadorResultadosQuery2_2] := peel(taDb2Array["PCBPRO"]," ")
																		taVOLUMESAux[nContadorResultadosQuery2_2] := peel(taDb2Array["VOLUMES"]," ")
																		taVOLUMESAuxOriginal[nContadorResultadosQuery2_2] := peel(taDb2Array["VOLUMES"]," ")
																		!taVOLUMESAux[nContadorResultadosQuery2_2] := peel(taDb2Array["UVCLIV"]," ")
																		taMSGLIGOriginal[nContadorResultadosQuery2_2] := peel(taDb2Array["MSGLIG"]," ")
																		split(taMSGLIGOriginal[nContadorResultadosQuery2_2],taDIPLIVCalculadoSplitado,"/")
																		taDIPLIVCalculado[nContadorResultadosQuery2_2] := peel(taDb2Array["DIPLIV"]," ")
																		taPRPPIC[nContadorResultadosQuery2_2] := peel(taDb2Array["PRPPIC"]," ")
																		taNUMSUP[nContadorResultadosQuery2_2] := peel(taDb2Array["NUMSUP"]," ")
																		taCODPRO[nContadorResultadosQuery2_2] := peel(taDb2Array["CODPRO"]," ")
																		taCPTMAS[nContadorResultadosQuery2_2] := peel(taDb2Array["CPTMAS"]," ")
																		taNF[nContadorResultadosQuery2_2] := peel(taDb2Array["NF"]," ")
																		if substr(peel(taDb2Array["SNF"]," "),2,1) = "1" or substr(peel(taDb2Array["SNF"]," "),2,1) = "2" or substr(peel(taDb2Array["SNF"]," "),2,1) = "3" or substr(peel(taDb2Array["SNF"]," "),2,1) = "4" or substr(peel(taDb2Array["SNF"]," "),2,1) = "5" or substr(peel(taDb2Array["SNF"]," "),2,1) = "6" or substr(peel(taDb2Array["SNF"]," "),2,1) = "7" or substr(peel(taDb2Array["SNF"]," "),2,1) = "8" or substr(peel(taDb2Array["SNF"]," "),2,1) = "9" or substr(peel(taDb2Array["SNF"]," "),2,1) = "0" then
																			taSNF[nContadorResultadosQuery2_2] := peel(taDb2Array["SNF"]," ")
																		else
																			taSNF[nContadorResultadosQuery2_2] := substr(peel(taDb2Array["SNF"]," "),1,1)
																		endif
																		taSUP_MASSIF[nContadorResultadosQuery2_2] := peel(taDb2Array["SUP_MASSIF"]," ")
																		taTOT_CX_PROD_NF[nContadorResultadosQuery2_2] := peel(taDb2Array["TOT_CX_PROD_NF"]," ")
																		!chave = produto, suporte , suporte massificado para consolidar
																		baProdutoSupDuplicado[nContadorResultadosQuery2_2] := FALSE
																		baULTProdutoSupDuplicado[nContadorResultadosQuery2_2] := TRUE
																		naQtdJaUtilizadaProd[taCODPRO[nContadorResultadosQuery2_2]] := 0
																		taCODMOP[nContadorResultadosQuery2_2] := peel(taDb2Array["CODMOP"]," ")
																		baJaFezTOT_CX_PROD_NF[nContadorResultadosQuery2_2] := FALSE
																		baConsolidou[nContadorResultadosQuery2_2] := FALSE
																		baJaAtualizou[nContadorResultadosQuery2_2] := FALSE
																		baPrecisaRecalcular[nContadorResultadosQuery2_2] := FALSE
																		!if nContadorResultadosQuery2_2 = 1 then
																		!	taVOLUMES[nContadorResultadosQuery2_2] := "1"
																		!else
																		!	taVOLUMES[nContadorResultadosQuery2_2] := build(number(taVOLUMES[nContadorResultadosQuery2_2-1])+number(taVOLUMESAux[nContadorResultadosQuery2_2-1]))
																		!endif
																		
																		!fazer a regra para sup_massif se for iguual a anterior nao aumentar o taVOLUMES e aumentar o taVOLUMESAux
																		remove(taDb2Array)


																	endwhile



																	if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
																		print("FATAL", tfSqlErrorStr())
																		 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																				exit(1)
																	endif
																	
																	
												endif					
												if taTYPSUPQuery2_1[nTempContadorResultadosQuery2_1] = "1" then					
																	
																	
																	
																	
																	
																	
																	
																	
																	
																	
																	
																	
																	
																	! segunda execucao
																	
																	!primeiro typesup = 1
															
															tQuery := build("SELECT SD.NUMSUP  "\
																		"	,SE.TYPSUP   "\
																		"	,SE.CIRPIC  "\
																		"	,SD.CODPRO "\
																		"	,QR.NUMSUP SUP_MASSIF "\
																		"	,SD.CPTMAS "\
																		"	,SUM(SD.UVCSRV) UVCSRV "\
																		"	,SUM(SD.UVCLIV) UVCLIV "\
																		"	,SD.PCBPRO  "\
																		"	,INTEGER(CEILING(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																		"	,TRIM(SE.CODMOP) CODMOP  "\
																		"	,TRIM(SD.DIPLIV) DIPLIV  "\
																		"	,LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																		"	,SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																		"	,SUM(SD.UVCSRV) as SOMAUVCSRV "\
																		"	FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																		"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																		"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																		"	LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR ON SD.CPTMAS=QR.CPTMAS AND SD.CODACT=QR.CODACT AND SD.CODPRO=QR.CODPRO "\
																		"	WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																		"	AND SE.TYPSUP<>3  "\
																		"	AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																		"	AND SD.UVCSRV<>0 "\
																		"   AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'  "\
																		"   AND SE.TYPSUP=1  "\
																		"	GROUP BY SD.NUMSUP "\
																		"	, SE.CODMOP "\
																		"	,SD.CPTMAS "\
																		"	,QR.NUMSUP "\
																		"	,SE.TYPSUP  "\
																		"	,SE.CIRPIC  "\
																		"	,SD.CODPRO   "\
																		"	,SD.PCBPRO   "\
																		"	,SD.DIPLIV   "\
																		"	,SE.REFLIV  "\
																		"	ORDER BY SE.TYPSUP DESC   "\
																		"	, SD.NUMSUP ASC  "\
																		"	, SD.CODPRO,QR.NUMSUP ")
																		
																		
																		
																		
																		tQuery := build("SELECT SD.NUMSUP  "\
																					"	,SE.TYPSUP   "\
																					"	,SE.CIRPIC  "\
																					"	,TRIM(SD.CODPRO) CODPRO "\
																					"	,QR1.NUMSUP SUP_MASSIF "\
																					"	,SD.CPTMAS "\
																					"	,SUM(SD.UVCSRV) UVCSRV "\
																					"	,SUM(SD.UVCLIV) UVCLIV "\
																					"	,QR2.TOT_CX_PROD_NF "\
																					"	,SD.PCBPRO  "\
																					"	,INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					"	,TRIM(SE.CODMOP) CODMOP  "\
																					"	,TRIM(SD.DIPLIV) DIPLIV  "\
																					"	,LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					"	,SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					"	,SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"	FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"	LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"	LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"	LEFT JOIN (SELECT NUMLIV, CODPRO, SUM(CEILING(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO) QR2 ON SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV "\
																					"	WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																					"	AND SE.TYPSUP<>3  "\
																					"	AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"	AND SD.UVCSRV<>0 "\
																					"   AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'  "\
																					"   AND SE.TYPSUP=1  "\
																					"	GROUP BY SD.NUMSUP "\
																					"	, SE.CODMOP "\
																					"	,SD.CPTMAS "\
																					"	,QR1.NUMSUP "\
																					"	,QR2.TOT_CX_PROD_NF "\
																					"	,SE.TYPSUP  "\
																					"	,SE.CIRPIC  "\
																					"	,SD.CODPRO  "\
																					"	,SD.PCBPRO  "\
																					"	,SD.DIPLIV  "\
																					"	,SE.REFLIV "\
																					"	ORDER BY SE.TYPSUP DESC "\
																					"	, SD.NUMSUP ASC"\
																					"	, SD.CODPRO ")
																					
																					
																					
																					
																					
																					
																		tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP   "\
																					",SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, CODPRO, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO) QR2 ON SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%' "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'  "\
																					"AND SE.TYPSUP=1  "\
																					"GROUP BY SD.NUMSUP "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY SE.TYPSUP DESC  "\
																					", SD.NUMSUP ASC "\
																					", SD.CODPRO ")
																					
																					
																					
																					
																					
																					
																					
																		tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP   "\
																					", SD.PRPPIC ,SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 1) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, CODPRO, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO) QR2 ON SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'   "\
																					"AND SE.TYPSUP=1   "\
																					"GROUP BY SD.NUMSUP , SD.PRPPIC "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY SE.TYPSUP DESC "\
																					", SD.NUMSUP ASC"\
																					", SD.CODPRO ")
																					
																					
																					
																					
																					
																		tQuery := build("SELECT SD.NUMSUP  "\
																					",SE.TYPSUP "\
																					",SE.CIRPIC  "\
																					",TRIM(SD.CODPRO) CODPRO "\
																					",QR1.NUMSUP SUP_MASSIF "\
																					",SD.CPTMAS "\
																					",SUM(SD.UVCSRV) UVCSRV "\
																					",SUM(SD.UVCLIV) UVCLIV "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SD.PCBPRO  "\
																					",INTEGER(FLOOR(SUM(SD.UVCSRV/SD.PCBPRO))) VOLUMES  "\
																					",TRIM(SE.CODMOP) CODMOP  "\
																					",TRIM(SD.DIPLIV) DIPLIV  "\
																					",LEFT(TRIM(SE.REFLIV), (LOCATE ('.', TRIM(SE.REFLIV))-1)) NF  "\
																					",SUBSTR(TRIM(SE.REFLIV), LOCATE ('.', TRIM(SE.REFLIV))+1, 2) SNF  "\
																					",SUM(SD.UVCSRV) as SOMAUVCSRV "\
																					"FROM FGE50FM",tToInfologPrefixFilename,".GESUPE SE "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GESUPD SD ON SE.NUMSUP=SD.NUMSUP AND SE.CODACT=SD.CODACT "\
																					"LEFT JOIN FGE50FM",tToInfologPrefixFilename,".GEPRO PD ON SD.CODPRO=PD.CODPRO AND SD.CODACT=PD.CODACT  "\
																					"LEFT JOIN (select numsup, codpro, CODACT, numliv, indmas, cptmas  from FGE50FM",tToInfologPrefixFilename,".gesupd where cptmas in(select distinct cptmas from FGE50FM",tToInfologPrefixFilename,".gesupd ) AND INDMAS='3') QR1 ON SD.CPTMAS=QR1.CPTMAS AND SD.CODACT=QR1.CODACT AND SD.CODPRO=QR1.CODPRO "\
																					"LEFT JOIN (SELECT NUMLIV, NUMSUP,CODPRO, cptmas, ceiling(SUM(UVCLIV/PCBPRO)) TOT_CX_PROD_NF FROM FGE50FM",tToInfologPrefixFilename,".GESUPD GROUP BY NUMLIV, CODPRO, cptmas, NUMSUP) QR2 ON SD.CPTMAS=QR2.CPTMAS AND SD.CODPRO=QR2.CODPRO AND SD.NUMLIV=QR2.NUMLIV AND SD.NUMSUP=QR2.NUMSUP "\
																					"WHERE SD.REFLIV LIKE '",tREFLIVaConsiderar,"%'  "\
																					"AND SE.TYPSUP<>3  "\
																					"AND SE.CLILIV NOT IN ('MASSIFICATION', 'MASSIFICAÃÃO', 'MASSIFICACAO') "\
																					"AND SD.UVCSRV<>0 "\
																					"AND SD.CODPRO='",taCODPROQuery2_1[nTempContadorResultadosQuery2_1],"'   "\
																					"AND SE.TYPSUP=1   "\
																					"GROUP BY SD.NUMSUP "\
																					", SE.CODMOP "\
																					",SD.CPTMAS "\
																					",QR1.NUMSUP "\
																					",QR2.TOT_CX_PROD_NF "\
																					",SE.TYPSUP  "\
																					",SE.CIRPIC  "\
																					",SD.CODPRO  "\
																					",SD.PCBPRO  "\
																					",SD.DIPLIV  "\
																					",SE.REFLIV "\
																					"ORDER BY  SE.TYPSUP DESC  "\
																					", SD.NUMSUP ASC "\
																					", SD.CODPRO") 
																		


															log(tQuery,NL)


																	if bfSqlSet( tDbBase ,"SELECTdb2"  , tQuery) = FALSE then
																				 print("FATAL ", tfSqlErrorStr())
																				 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																				exit(1)

																	endif

																	if bfSqlOpen( tDbBase , "SELECTdb2" ) = FALSE then
																		 print("FATAL ", tfSqlErrorStr())
																		  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																				exit(1)

																	endif






																	while bfSqlFetchArray( tDbBase , "SELECTdb2" ,taDb2Array) = TRUE do
																		nContadorResultadosQuery2_2++



																		log("SOMAUVCSRV ",peel(taDb2Array["SOMAUVCSRV"]," "),NL)
																		log("PCBPRO ",peel(taDb2Array["PCBPRO"]," "),NL)
																		taTYPSUP[nContadorResultadosQuery2_2] := peel(taDb2Array["TYPSUP"]," ")
																		taSOMAUVCSRV[nContadorResultadosQuery2_2] := peel(taDb2Array["SOMAUVCSRV"]," ")
																		taPCBPRO[nContadorResultadosQuery2_2] := peel(taDb2Array["PCBPRO"]," ")
																		taVOLUMESAux[nContadorResultadosQuery2_2] := peel(taDb2Array["VOLUMES"]," ")
																		taVOLUMESAuxOriginal[nContadorResultadosQuery2_2] := peel(taDb2Array["VOLUMES"]," ")
																		!taVOLUMESAux[nContadorResultadosQuery2_2] := peel(taDb2Array["UVCLIV"]," ")
																		taMSGLIGOriginal[nContadorResultadosQuery2_2] := peel(taDb2Array["MSGLIG"]," ")
																		split(taMSGLIGOriginal[nContadorResultadosQuery2_2],taDIPLIVCalculadoSplitado,"/")
																		taDIPLIVCalculado[nContadorResultadosQuery2_2] := peel(taDb2Array["DIPLIV"]," ")
																		taNUMSUP[nContadorResultadosQuery2_2] := peel(taDb2Array["NUMSUP"]," ")
																		taCODPRO[nContadorResultadosQuery2_2] := peel(taDb2Array["CODPRO"]," ")
																		taCPTMAS[nContadorResultadosQuery2_2] := peel(taDb2Array["CPTMAS"]," ")
																		taNF[nContadorResultadosQuery2_2] := peel(taDb2Array["NF"]," ")
																		if substr(peel(taDb2Array["SNF"]," "),2,1) = "1" or substr(peel(taDb2Array["SNF"]," "),2,1) = "2" or substr(peel(taDb2Array["SNF"]," "),2,1) = "3" or substr(peel(taDb2Array["SNF"]," "),2,1) = "4" or substr(peel(taDb2Array["SNF"]," "),2,1) = "5" or substr(peel(taDb2Array["SNF"]," "),2,1) = "6" or substr(peel(taDb2Array["SNF"]," "),2,1) = "7" or substr(peel(taDb2Array["SNF"]," "),2,1) = "8" or substr(peel(taDb2Array["SNF"]," "),2,1) = "9" or substr(peel(taDb2Array["SNF"]," "),2,1) = "0" then
																			taSNF[nContadorResultadosQuery2_2] := peel(taDb2Array["SNF"]," ")
																		else
																			taSNF[nContadorResultadosQuery2_2] := substr(peel(taDb2Array["SNF"]," "),1,1)
																		endif
																		taSUP_MASSIF[nContadorResultadosQuery2_2] := peel(taDb2Array["SUP_MASSIF"]," ")
																		taTOT_CX_PROD_NF[nContadorResultadosQuery2_2] := peel(taDb2Array["TOT_CX_PROD_NF"]," ")
																		!chave = produto, suporte , suporte massificado para consolidar
																		baProdutoSupDuplicado[nContadorResultadosQuery2_2] := FALSE
																		baULTProdutoSupDuplicado[nContadorResultadosQuery2_2] := TRUE
																		naQtdJaUtilizadaProd[taCODPRO[nContadorResultadosQuery2_2]] := 0
																		taCODMOP[nContadorResultadosQuery2_2] := peel(taDb2Array["CODMOP"]," ")
																		baJaFezTOT_CX_PROD_NF[nContadorResultadosQuery2_2] := FALSE
																		baConsolidou[nContadorResultadosQuery2_2] := FALSE
																		baJaAtualizou[nContadorResultadosQuery2_2] := FALSE
																		baPrecisaRecalcular[nContadorResultadosQuery2_2] := FALSE
																		
																		tQuery2 := build("SELECT  NUMSUP "\
																						"       ,CODPRO "\
																						"       ,PRPPIC "\
																						"FROM FGE50FM",tToInfologPrefixFilename,".gesupd "\
																						"WHERE codpro='",taCODPRO[nContadorResultadosQuery2_2],"' "\
																						"AND numsup='",taNUMSUP[nContadorResultadosQuery2_2],"'")
																		
																		log(tQuery2,NL)


																		if bfSqlSet( tDbBase2 ,"SELECTdb2"  , tQuery2) = FALSE then
																					print("FATAL ", tfSqlErrorStr())
																					bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																					exit(1)
																		endif

																		if bfSqlOpen( tDbBase2 , "SELECTdb2" ) = FALSE then
																			print("FATAL ", tfSqlErrorStr())
																			bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																					exit(1)
																		endif

																		if bfSqlFetchArray( tDbBase2 , "SELECTdb2" ,taDb2Array) = TRUE then
																			taPRPPIC[nContadorResultadosQuery2_2] := peel(taDb2Array["PRPPIC"]," ")
																			! remove(taDb2Array)
																		endif

																		if bfSqlFree( tDbBase2 , "SELECTdb2"  ) = FALSE then
																			print("FATAL", tfSqlErrorStr())
																			bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																			exit(1)
																		endif
																		
																		!if nContadorResultadosQuery2_2 = 1 then
																		!	taVOLUMES[nContadorResultadosQuery2_2] := "1"
																		!else
																		!	taVOLUMES[nContadorResultadosQuery2_2] := build(number(taVOLUMES[nContadorResultadosQuery2_2-1])+number(taVOLUMESAux[nContadorResultadosQuery2_2-1]))
																		!endif
																		
																		!fazer a regra para sup_massif se for iguual a anterior nao aumentar o taVOLUMES e aumentar o taVOLUMESAux
																		remove(taDb2Array)


																	endwhile



																	if bfSqlFree( tDbBase , "SELECTdb2"  ) = FALSE then
																		print("FATAL", tfSqlErrorStr())
																		 bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("Erro na execucao da query ",tQuery," do banco de dados: ",tfSqlErrorStr()))
																				exit(1)
																	endif
																	
												endif					
																	
											endif
											nTempContadorResultadosQuery2_1++
										endwhile
										
										
										
							!consolidar
							
							
							
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
							
								taVOLUMESAux[nTempContadorResultQuery2_2] := taTOT_CX_PROD_NF[(nTempContadorResultQuery2_2)]
								

																		
								if nTempContadorResultQuery2_2 = 1 then
										taVOLUMES[nTempContadorResultQuery2_2] := "1"
								else
										taVOLUMES[nTempContadorResultQuery2_2] := build(number(taVOLUMES[(nTempContadorResultQuery2_2-1)]) + number(taVOLUMESAux[(nTempContadorResultQuery2_2-1)]))
									
								endif
									
								log("----------------------------",NL)	
								log("taCODPRO[nTempContadorResultQuery2_2] ",taCODPRO[nTempContadorResultQuery2_2],NL)
								log("taVOLUMES[nTempContadorResultQuery2_2] ",taVOLUMES[nTempContadorResultQuery2_2],NL)
								log("taVOLUMESAux[nTempContadorResultQuery2_2] ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
								
								nTempContadorResultQuery2_2++
							endwhile
							
							
							
							
							/*
							
							Ã© possivel criar uma logica na volumetria que se a quantidade de volumes TOT_cx for maior em 2 nÃºmeros que a coluna volumes 
							(Ex: soma TOT_cx do mesmo produto no mesmo suporte = 10 e soma volumes do mesmo produto no mesmo suporte = 8) 
							entÃ£o ele subtrai 1 do soma TOT_Cx. Ficando com 9 ao inves de 10


							*/
							
							
							
							
							
							
							!consolidar sup_massif se for iguual a anterior nao aumentar o taVOLUMES e aumentar o taVOLUMESAux
							!chave = produto, suporte , suporte massificado para consolidar
							
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
								if baConsolidou[nTempContadorResultQuery2_2] = FALSE then
									nContadorDif := 0
									nTempContadorResultQuery2_2_3 := nTempContadorResultQuery2_2+1
									while nTempContadorResultQuery2_2_3 <= nContadorResultadosQuery2_2 do
										if taCODPRO[nTempContadorResultQuery2_2_3] = taCODPRO[nTempContadorResultQuery2_2] and taNUMSUP[nTempContadorResultQuery2_2_3] = taNUMSUP[nTempContadorResultQuery2_2] and taSUP_MASSIF[nTempContadorResultQuery2_2_3] = taSUP_MASSIF[nTempContadorResultQuery2_2] then
											if baConsolidou[nTempContadorResultQuery2_2_3] = FALSE then
												baConsolidou[nTempContadorResultQuery2_2] := TRUE
												baConsolidou[nTempContadorResultQuery2_2_3] := TRUE
												baProdutoSupDuplicado[nTempContadorResultQuery2_2_3] := TRUE
												
												log("------consolidando----------",NL)	
												log("taCODPRO[nTempContadorResultQuery2_2] ",taCODPRO[nTempContadorResultQuery2_2],NL)
												log("taVOLUMESAuxOriginal[nTempContadorResultQuery2_2] antes ",taVOLUMESAuxOriginal[nTempContadorResultQuery2_2],NL)
												log("taVOLUMESAux[nTempContadorResultQuery2_2] antes ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
												taVOLUMESAux[nTempContadorResultQuery2_2] := build(number(taVOLUMESAux[nTempContadorResultQuery2_2])+number(taVOLUMESAux[nTempContadorResultQuery2_2_3]))
												taVOLUMESAuxOriginal[nTempContadorResultQuery2_2] := build(number(taVOLUMESAuxOriginal[nTempContadorResultQuery2_2])+number(taVOLUMESAuxOriginal[nTempContadorResultQuery2_2_3]))
												
												log("taVOLUMESAuxOriginal[nTempContadorResultQuery2_2] depoois ",taVOLUMESAuxOriginal[nTempContadorResultQuery2_2],NL)
												log("taVOLUMESAux[nTempContadorResultQuery2_2] depois ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
												
												!
												baULTProdutoSupDuplicado[nTempContadorResultQuery2_2_3] := TRUE
												baULTProdutoSupDuplicado[nTempContadorResultQuery2_2] := FALSE
												!taVOLUMESAux[nTempContadorResultQuery2_2_3] := taVOLUMESAux[nTempContadorResultQuery2_2]
												!taVOLUMESAuxOriginal[nTempContadorResultQuery2_2_3] := taVOLUMESAuxOriginal[nTempContadorResultQuery2_2]
												!taVOLUMES[nTempContadorResultQuery2_2_3] := taVOLUMES[nTempContadorResultQuery2_2]
											endif
										endif
										nTempContadorResultQuery2_2_3++
									endwhile
								
								endif
								
								
								nTempContadorResultQuery2_2++
							endwhile
							
							
							
							
							!replica para os duplicados o valor do primeiro
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
								nTempContadorResultQuery2_2_3 := nTempContadorResultQuery2_2+1
								while nTempContadorResultQuery2_2_3 <= nContadorResultadosQuery2_2 do
									if taCODPRO[nTempContadorResultQuery2_2_3] = taCODPRO[nTempContadorResultQuery2_2] and taNUMSUP[nTempContadorResultQuery2_2_3] = taNUMSUP[nTempContadorResultQuery2_2] and taSUP_MASSIF[nTempContadorResultQuery2_2_3] = taSUP_MASSIF[nTempContadorResultQuery2_2] then
										baPrecisaRecalcular[nTempContadorResultQuery2_2_3] := TRUE
										taVOLUMESAux[nTempContadorResultQuery2_2_3] := taVOLUMESAux[nTempContadorResultQuery2_2]
										taVOLUMESAuxOriginal[nTempContadorResultQuery2_2_3] := taVOLUMESAuxOriginal[nTempContadorResultQuery2_2]
										taVOLUMES[nTempContadorResultQuery2_2_3] := taVOLUMES[nTempContadorResultQuery2_2]
									endif
									nTempContadorResultQuery2_2_3++
									endwhile
								
								nTempContadorResultQuery2_2++
							endwhile
							
							
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
								nContadorDif := number(taVOLUMESAux[nTempContadorResultQuery2_2]) - number(taVOLUMESAuxOriginal[nTempContadorResultQuery2_2])
								log("nContadorDif ",nContadorDif,NL)
								log("number(taVOLUMESAux[nTempContadorResultQuery2_2]) ",number(taVOLUMESAux[nTempContadorResultQuery2_2]),NL)
								log("number(taVOLUMESAuxOriginal[nTempContadorResultQuery2_2]) ",number(taVOLUMESAuxOriginal[nTempContadorResultQuery2_2]),NL)
								if nContadorDif >= 2 and baConsolidou[nTempContadorResultQuery2_2] = TRUE then
									!faz um ciclo para ver se precisa de corrigir arredondamento o somatorio
									/*
							
									Ã© possivel criar uma logica na volumetria que se a quantidade de volumes TOT_cx for maior em 2 nÃºmeros que a coluna volumes 
									(Ex: soma TOT_cx do mesmo produto no mesmo suporte = 10 e soma volumes do mesmo produto no mesmo suporte = 8) 
									entÃ£o ele subtrai 1 do soma TOT_Cx. Ficando com 9 ao inves de 10


									*/
									log("alterando em opcao 1 para o CODPRO ",taCODPRO[nTempContadorResultQuery2_2]," taVOLUMESAux[nTempContadorResultQuery2_2] ",taVOLUMESAux[nTempContadorResultQuery2_2]," para ",build(number(taVOLUMESAux[nTempContadorResultQuery2_2])-1),NL)
									
									taVOLUMESAux[nTempContadorResultQuery2_2] := build(number(taVOLUMESAux[nTempContadorResultQuery2_2])-1)
									
									
									
								
								endif
								
							
								nTempContadorResultQuery2_2++
							endwhile
							
							
							
							!recalcula os valores de volumes
							
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
							
								
								

																		
								if nTempContadorResultQuery2_2 = 1 then
										taVOLUMES[nTempContadorResultQuery2_2] := "1"
								else
									if baPrecisaRecalcular[nTempContadorResultQuery2_2] = FALSE then
										taVOLUMES[nTempContadorResultQuery2_2] := build(number(taVOLUMES[(nTempContadorResultQuery2_2-1)]) + number(taVOLUMESAux[(nTempContadorResultQuery2_2-1)]))
									else
										taVOLUMES[nTempContadorResultQuery2_2] := build(number(taVOLUMES[(nTempContadorResultQuery2_2-1)]))
									endif
									
								endif
									
								log("---------recalculado---------",NL)	
								log("taCODPRO[nTempContadorResultQuery2_2] ",taCODPRO[nTempContadorResultQuery2_2],NL)
								log("taVOLUMES[nTempContadorResultQuery2_2] ",taVOLUMES[nTempContadorResultQuery2_2],NL)
								log("taVOLUMESAux[nTempContadorResultQuery2_2] ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
								
								nTempContadorResultQuery2_2++
							endwhile
							
							
							/*
							!so para saber qual o ultimo produto
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
								nTempContadorResultQuery2_2_3 := nTempContadorResultQuery2_2+1
								while nTempContadorResultQuery2_2_3 <= nContadorResultadosQuery2_2 do
									if taCODPRO[nTempContadorResultQuery2_2_3] = taCODPRO[nTempContadorResultQuery2_2]  then
										
										baULTProdutoSupDuplicado[nTempContadorResultQuery2_2_3] := TRUE
										baULTProdutoSupDuplicado[nTempContadorResultQuery2_2] := FALSE
									endif
									nTempContadorResultQuery2_2_3++
								endwhile
								nTempContadorResultQuery2_2++
							endwhile
							*/
							
							
							
							
							/*
							!para produtos que o SUP_MASSIF Ã© distintos
							
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
								nTempContadorResultQuery2_2_3 := nTempContadorResultQuery2_2+1
								while nTempContadorResultQuery2_2_3 <= nContadorResultadosQuery2_2 do
									if taCODPRO[nTempContadorResultQuery2_2_3] = taCODPRO[nTempContadorResultQuery2_2] and taNUMSUP[nTempContadorResultQuery2_2_3] = taNUMSUP[nTempContadorResultQuery2_2] and taSUP_MASSIF[nTempContadorResultQuery2_2_3] <> taSUP_MASSIF[nTempContadorResultQuery2_2] and baJaFezTOT_CX_PROD_NF[nTempContadorResultQuery2_2_3] = FALSE then
									!if taCODPRO[nTempContadorResultQuery2_2_3] = taCODPRO[nTempContadorResultQuery2_2] and  baJaFezTOT_CX_PROD_NF[nTempContadorResultQuery2_2_3] = FALSE and baProdutoSupDuplicado[nTempContadorResultQuery2_2_3] = FALSE and and baProdutoSupDuplicado[nTempContadorResultQuery2_2] = FALSE then
										baJaFezTOT_CX_PROD_NF[nTempContadorResultQuery2_2_3] := TRUE
										taTOT_CX_PROD_NF[nTempContadorResultQuery2_2] := taVOLUMESAux[nTempContadorResultQuery2_2]
										taTOT_CX_PROD_NF[nTempContadorResultQuery2_2_3] := build(number(taVOLUMESAux[nTempContadorResultQuery2_2_3]) + number(taTOT_CX_PROD_NF[nTempContadorResultQuery2_2]))
									endif
									nTempContadorResultQuery2_2_3++
								endwhile
								nTempContadorResultQuery2_2++
							endwhile
							*/
							
							
							nTempContadorResultQuery2_2 := 1
							while nTempContadorResultQuery2_2 <= nContadorResultadosQuery2_2 do
								/*
								if baProdutoSupDuplicado[nTempContadorResultQuery2_2] = FALSE then
								
								
									
									if nTempContadorResultQuery2_2 = 1 then
										if baULTProdutoSupDuplicado[nTempContadorResultQuery2_2] = FALSE then
											taVOLUMES[nTempContadorResultQuery2_2] := "1"
											taVOLUMESAux[nTempContadorResultQuery2_2] :=  build(number(taTOT_CX_PROD_NF[nTempContadorResultQuery2_2]) - naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]])
											log("nTempContadorResultQuery2_2 = 1",NL)
											log("ultimo produto duplicado ",taCODPRO[nTempContadorResultQuery2_2]," com NUMSUP ",taNUMSUP[nTempContadorResultQuery2_2]," e taSUP_MASSIF ",taSUP_MASSIF[nTempContadorResultQuery2_2],NL)
											log("taTOT_CX_PROD_NF[nTempContadorResultQuery2_2] ",taTOT_CX_PROD_NF[nTempContadorResultQuery2_2],NL)
											log("naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] ",naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]],NL)
											
											log("----------------------------------------------------",NL)
											
											naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] := naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] + number(taVOLUMESAux[nTempContadorResultQuery2_2])
											
											log("opcao 1",NL)
											log("taVOLUMES ",taVOLUMES[nTempContadorResultQuery2_2],NL)
											log("taVOLUMESAux ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
										else
											
											log("taTOT_CX_PROD_NF[nTempContadorResultQuery2_2] ",taTOT_CX_PROD_NF[nTempContadorResultQuery2_2],NL)
											log("naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] ",naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]],NL)
											log("----------------------------------------------------",NL)
											taVOLUMES[nTempContadorResultQuery2_2] := "1"
											taVOLUMESAux[nTempContadorResultQuery2_2] := build(number(taTOT_CX_PROD_NF[nTempContadorResultQuery2_2]) - naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]])
											naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] := naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] + number(taVOLUMESAux[nTempContadorResultQuery2_2])
											log("opcao 2",NL)
											log("taVOLUMES ",taVOLUMES[nTempContadorResultQuery2_2],NL)
											log("taVOLUMESAux ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
										endif
									else
										if baULTProdutoSupDuplicado[nTempContadorResultQuery2_2] = FALSE then
											taVOLUMES[nTempContadorResultQuery2_2] := build(number(taVOLUMES[nTempContadorResultQuery2_2-1])+number(taVOLUMESAux[nTempContadorResultQuery2_2-1]))
											taVOLUMESAux[nTempContadorResultQuery2_2] := build(number(taTOT_CX_PROD_NF[nTempContadorResultQuery2_2]) - naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]])
											naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] := naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] + number(taVOLUMESAux[nTempContadorResultQuery2_2])
											log("opcao 3",NL)
											log("taVOLUMES ",taVOLUMES[nTempContadorResultQuery2_2],NL)
											log("taVOLUMESAux ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
										
										else
											log("ultimo produto duplicado ",taCODPRO[nTempContadorResultQuery2_2]," com NUMSUP ",taNUMSUP[nTempContadorResultQuery2_2]," e taSUP_MASSIF ",taSUP_MASSIF[nTempContadorResultQuery2_2],NL)
											log("taTOT_CX_PROD_NF[nTempContadorResultQuery2_2] ",taTOT_CX_PROD_NF[nTempContadorResultQuery2_2],NL)
											log("naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]] ",naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]],NL)
											log("----------------------------------------------------",NL)
											taVOLUMES[nTempContadorResultQuery2_2] := build(number(taVOLUMES[nTempContadorResultQuery2_2-1])+number(taVOLUMESAux[nTempContadorResultQuery2_2-1]))
											taVOLUMESAux[nTempContadorResultQuery2_2] := build(number(taTOT_CX_PROD_NF[nTempContadorResultQuery2_2]) - naQtdJaUtilizadaProd[taCODPRO[nTempContadorResultQuery2_2]])
											log("opcao 4",NL)
											log("taVOLUMES ",taVOLUMES[nTempContadorResultQuery2_2],NL)
											log("taVOLUMESAux ",taVOLUMESAux[nTempContadorResultQuery2_2],NL)
											
										endif
										
									endif
									
									
									
									
								else
									!se for duplicado fica igual ao anterior
									taVOLUMES[nTempContadorResultQuery2_2] := taVOLUMES[(nTempContadorResultQuery2_2-1)]
									taVOLUMESAux[nTempContadorResultQuery2_2] := taVOLUMESAux[(nTempContadorResultQuery2_2-1)]
								endif
								*/	
								
								
								
								
								
								
								
								
								
									
									
								!fazer update
								/*

								UPDATE FGE50FM",tToInfologPrefixFilename,".GESUPD
								SET MSGLIG='VOLUME_INICIAL / VOLUMES' (Conta Tradex) /DIPLIV /NF/SNF
								WHERE NUMSUP='Select_Volumes.NUMSUP'
								AND CODPRO='Select_Volumes.CODPRO'
								*/


								/*
								divido o volumesaux / pcbpro e arrendonda para cima
								taVOLUMESAux[nTempContadorResultQuery2_2] := build(number(taVOLUMESAux[nTempContadorResultQuery2_2]) / number(taPCBPRO[nTempContadorResultQuery2_2]))
								
								
								tCont := build(number(taVOLUMESAux[nTempContadorResultQuery2_2])*1)	
								nPosicaoPonto := 0
								   nPosicaoPonto := index(tCont,".")
								   if (nPosicaoPonto) > 0 then
									  
									  tCont := build(number(substr(tCont,1,nPosicaoPonto-1))+1)
									else
									  tCont := build(number(tCont))
									 
								   endif
								   
								   taVOLUMESAux[nTempContadorResultQuery2_2] := tCont
						
								*/
								
								
								
								if taCODMOP[nTempContadorResultQuery2_2] = "ECO"  then
									taVOLUMES[nTempContadorResultQuery2_2] := "1"
								endif
								
								
								
								/*
								if taCODMOP[nTempContadorResultQuery2_2] = "ECO"  and nTempContadorResultQuery2_2 >= 2 and taNUMSUP[nContadorResultadosQuery2_2] <> taNUMSUP[(nContadorResultadosQuery2_2-1)] then
									! segue a regra de incrementar
								else
									if taCODMOP[nTempContadorResultQuery2_2] = "ECO" then
										if nTempContadorResultQuery2_2 = 1 then
											taVOLUMES[nTempContadorResultQuery2_2] := "1"
										else
											taVOLUMES[nTempContadorResultQuery2_2] := taVOLUMES[(nTempContadorResultQuery2_2-1)]
										endif
									endif
								endif
								
								*/
								
								/*
								if taCODMOP[nTempContadorResultQuery2_2] = "ECO"  then
											taVOLUMESAux[nTempContadorResultQuery2_2] := "1"
								endif
								*/
								
								if number(taVOLUMESAux[nTempContadorResultQuery2_2]) = 0 then
									taVOLUMESAux[nTempContadorResultQuery2_2] := "1"
								endif
								
								taQueryUpdade[nTempContadorResultQuery2_2] := build("UPDATE FGE50FM",tToInfologPrefixFilename,".GESUPD "\
									"SET MSGLIG='",build(number(taVOLUMES[nTempContadorResultQuery2_2]):R05),"/",build(number(taVOLUMESAux[nTempContadorResultQuery2_2]):R05),"/",build(number(taDIPLIVCalculado[nTempContadorResultQuery2_2]):R05),"/",build(number(taNF[nTempContadorResultQuery2_2]):R06),"/",build(number(taSNF[nTempContadorResultQuery2_2]):R03),"'  "\
									"WHERE NUMSUP='",taNUMSUP[nTempContadorResultQuery2_2],"' "\
									"AND CODPRO='",taCODPRO[nTempContadorResultQuery2_2],"'  AND CPTMAS='",taCPTMAS[nTempContadorResultQuery2_2],"'  WITH NONE")


								log(taQueryUpdade[nTempContadorResultQuery2_2],NL)


								!colocar aqui o update


										if not bfSqlSet(tDbBase2, "Updatedb2", taQueryUpdade[nTempContadorResultQuery2_2]) then
										  log(tfSqlErrorStr(), NL)
										  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("1 - Erro na execucao da query ",taQueryUpdade[nTempContadorResultQuery2_2]," do banco de dados: ",tfSqlErrorStr()))
										  exit(27)
									   endif
									   if not bfSqlExec(tDbBase2, "Updatedb2") then
										  log(tfSqlErrorStr(), NL)
										  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("2 - Erro na execucao da query ",taQueryUpdade[nTempContadorResultQuery2_2]," do banco de dados: ",tfSqlErrorStr()))
										  exit(28)
									   endif
									   if not bfSqlCommit(tDbBase2, "Updatedb2") then
										  log(tfSqlErrorStr(), NL)
										  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("3 - Erro na execucao da query ",taQueryUpdade[nTempContadorResultQuery2_2]," do banco de dados: ",tfSqlErrorStr()))
										  exit(29)
									   endif
									   if not bfSqlFree(tDbBase2, "Updatedb2") then
										  log(tfSqlErrorStr(), NL)
										  bfMajtraceUPDATE("Erro de Traducao","1",tNumeroDocumento,tDataDocumento,tFileInput,tFileOut,"Produtos",build("4 - Erro na execucao da query ",taQueryUpdade[nTempContadorResultQuery2_2]," do banco de dados: ",tfSqlErrorStr()))
										  exit(30)
									   endif	
									
									
									
									
								
								
								
								
								nTempContadorResultQuery2_2++
							endwhile
							
							
							
							
							
							
							
							
							
							
										

							if nContadorResultadosQuery2_2 > 0 and bFazupdade2 = TRUE then
								bfMajtraceUPDATE("Recebida","0",build(tPlacaVeiculo,"-",tRomaneio),tDataDocumento,tFileInput,tFileOut,"Produtos","")
							endif

						endif


































			endif



	endif


endline


line("99.00")


endline

!===========================================================

! Default statements section
default

enddefault

!===========================================================

! End statements section

end

bfSqlClose(tDbBase)
bfSqlClose(tDbBase2)
	exit(0)
endend



!===========================================================



!===========================================================


function bfMajtraceSerie(tStatus,tError,tNumDoc,tDataDoc,tInput,tFileOut,tTipoDocumento,tMensagemErrro)
   TRACE:=new(build(sHOME,"/trace"))
   TRACE.ESTADO := tStatus
   TRACE.ERRO := tError
   TRACE.DATATRADUCAO := time("now","%Y-%m-%dT%H:%M:%S")
   TRACE.MENSAGEM := tTipoDocumento


		TRACE.PERFIL := "HARMAN"

   TRACE.SENTIDO := "O"
   TRACE.MENSAGEM := "M97 - CONF SERIE"
   TRACE.NUMDOC := tREFLIV
   TRACE.DATDOC := time("now","%Y-%m-%d")
   TRACE.MESSAGEID := build(nMessageID:R06)

    TRACE.REDE := substr(pEDISEND.ORIGINAL.NAME,1,20)
TRACE.SYSLOG_INDEX := build(SYSLOG.INDEX)
 TRACE.FICHEIROSAIDA := tNameOut
   if tStatus = "Recebida" then
   print(build("Ficheiro de Saida: "),tFileOut,NL,NL) >> TRACE.Detail


  print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
  print("Traduzida com Sucesso",NL) >> TRACE.Detail

  else
          if tStatus = "Erro de Traducao" then

        print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
        print("Erro de Traducao",NL) >> TRACE.Detail
        print(tMensagemErrro,NL) >> TRACE.Detail


        endif
  endif
close(TRACE.Detail)
close(SYSLOG.a)


if nMainIndex = 0 then
copy(SYSLOG.a,TRACE.In)
close(SYSLOG.a)
close(TRACE.In)


	nMainIndex := TRACE.INDEX
else
	tCmd := build("ln -s ", sHOME, "/trace/files/In/", nMainIndex, " ", TRACE.In)
	system(tCmd)
endif
flush(TRACE)



close(tFileOutTemp)
	copy(tFileOutTemp,TRACE.Out)
	close(tFileOutTemp)
	close(TRACE.Out)


system("sleep 1")

endfunction


!===========================================================


!===========================================================


!===========================================================


!===========================================================



function bfMajtraceUPDATE(tStatus,tError,tNumDoc,tDataDoc,tInput,tFileOut,tTipoDocumento,tMensagemErrro)
   TRACE:=new(build(sHOME,"/trace"))
   TRACE.ESTADO := tStatus
   TRACE.ERRO := tError
   TRACE.DATATRADUCAO := time("now","%Y-%m-%dT%H:%M:%S")
   TRACE.MENSAGEM := tTipoDocumento



   TRACE.PERFIL := "HARMAN"
   TRACE.SENTIDO := "O"
   TRACE.MENSAGEM := "M97 - UPDATE"
   TRACE.NUMDOC := tREFLIVaConsiderar
   TRACE.DATDOC := time("now","%Y-%m-%d")
   TRACE.MESSAGEID := build(nMessageID:R06)
TRACE.LIBEXC := tNUMVAG
    TRACE.REDE := substr(pEDISEND.ORIGINAL.NAME,1,20)
TRACE.SYSLOG_INDEX := build(SYSLOG.INDEX)
 TRACE.FICHEIROSAIDA := tNameOut
   if tStatus = "Recebida" then
   print(build("Ficheiro de Saida: "),tFileOut,NL,NL) >> TRACE.Detail


  print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
  print("Traduzida com Sucesso",NL) >> TRACE.Detail

  else
          if tStatus = "Erro de Traducao" then

        print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
        print("Erro de Traducao",NL) >> TRACE.Detail
        print(tMensagemErrro,NL) >> TRACE.Detail


        endif
  endif
close(TRACE.Detail)
close(SYSLOG.a)


if nMainIndex = 0 then
copy(SYSLOG.a,TRACE.In)
close(SYSLOG.a)
close(TRACE.In)


	nMainIndex := TRACE.INDEX
else
	tCmd := build("ln -s ", sHOME, "/trace/files/In/", nMainIndex, " ", TRACE.In)
	system(tCmd)
endif
flush(TRACE)



	nTmpContadorResultadosQuery := 1
	while nTmpContadorResultadosQuery <= nContadorResultadosQuery do
		print(taQueryUpdade[nTmpContadorResultadosQuery],NL) >> TRACE.Out
		nTmpContadorResultadosQuery++
	endwhile
	close(TRACE.Out)





endfunction



!===========================================================


!===========================================================


!===========================================================


!===========================================================



function bfMajtracePED(tStatus,tError,tNumDoc,tDataDoc,tInput,tFileOut,tTipoDocumento,tMensagemErrro)
   TRACE:=new(build(sHOME,"/trace"))
   TRACE.ESTADO := tStatus
   TRACE.ERRO := tError
   TRACE.DATATRADUCAO := time("now","%Y-%m-%dT%H:%M:%S")
   TRACE.MENSAGEM := tTipoDocumento

   TRACE.PERFIL := "HARMAN"
   TRACE.SENTIDO := "O"
   if length(taPedido[2]) > 0 then
   		TRACE.MENSAGEM := build("CONFIRMACAO DE PEDIDO - TOTVS RM")
   else
   		TRACE.MENSAGEM := "CONFIRMACAO DE PEDIDO - TOTVS RM"
   endif
   TRACE.LIBEXC := tNUMVAG
		TRACE.NUMDOC := build(tVAL_REFLIVQuery2,".",tVAL_SERIEQuery2)


   !if number(tData) > 0 then
	TRACE.DATDOC := tfConvertDate(substr(tDATA_M97Query2,1,10), "DD-MM-YYYY" , "YYYY-MM-DD")
!   endif
   TRACE.MESSAGEID := build(nMessageID:R010)

    TRACE.REDE := substr(pEDISEND.ORIGINAL.NAME,1,20)
TRACE.SYSLOG_INDEX := build(SYSLOG.INDEX)
 TRACE.FICHEIROSAIDA := tNameOutPED
   if tStatus = "Recebida" then
   print(build("Ficheiro de Saida: "),tFileOutPED,NL,NL) >> TRACE.Detail


  print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
  print("Traduzida com Sucesso",NL) >> TRACE.Detail

  else
          if tStatus = "Erro de Traducao" then

        print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
        print("Erro de Traducao",NL) >> TRACE.Detail
        print(tMensagemErrro,NL) >> TRACE.Detail
        endif
  endif
close(TRACE.Detail)
close(SYSLOG.a)


if nMainIndex = 0 then
copy(SYSLOG.a,TRACE.In)
close(SYSLOG.a)
close(TRACE.In)


	nMainIndex := TRACE.INDEX
else
	tCmd := build("ln -s ", sHOME, "/trace/files/In/", nMainIndex, " ", TRACE.In)
	system(tCmd)
endif



close(tFileOutTempPED)
copy(tFileOutTempPED,TRACE.Out)
close(tFileOutTempPED)
close(TRACE.Out)


flush(TRACE)

endfunction



!===========================================================
!===========================================================


!===========================================================



!===========================================================


function bfMajtraceM62(tStatus,tError,tNumDoc,tDataDoc,tInput,tFileOut,tTipoDocumento,tMensagemErrro)
   TRACE:=new(build(sHOME,"/trace"))
   TRACE.ESTADO := tStatus
   TRACE.ERRO := tError
   TRACE.DATATRADUCAO := time("now","%Y-%m-%dT%H:%M:%S")
   TRACE.MENSAGEM := tTipoDocumento


		TRACE.PERFIL := "HARMAN"

   TRACE.SENTIDO := "O"
   TRACE.MENSAGEM := build("M97 - M62 - ",tNUMVAG)
   !TRACE.NUMDOC := tREFLIVaConsiderar
   TRACE.DATDOC := time("now","%Y-%m-%d")
   TRACE.MESSAGEID := build(nMessageID:R06)

    TRACE.REDE := substr(pEDISEND.ORIGINAL.NAME,1,20)
TRACE.SYSLOG_INDEX := build(SYSLOG.INDEX)
 TRACE.FICHEIROSAIDA := tNameOutM62
   if tStatus = "Recebida" then
   print(build("Ficheiro de Saida: "),tFileOutM62,NL,NL) >> TRACE.Detail


  print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
  print("Traduzida com Sucesso",NL) >> TRACE.Detail

  else
          if tStatus = "Erro de Traducao" then

        print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
        print("Erro de Traducao",NL) >> TRACE.Detail
        print(tMensagemErrro,NL) >> TRACE.Detail


        endif
  endif
close(TRACE.Detail)
close(SYSLOG.a)


if nMainIndex = 0 then
copy(SYSLOG.a,TRACE.In)
close(SYSLOG.a)
close(TRACE.In)


	nMainIndex := TRACE.INDEX
else
	tCmd := build("ln -s ", sHOME, "/trace/files/In/", nMainIndex, " ", TRACE.In)
	system(tCmd)
endif
flush(TRACE)



close(tFileOutTempM62)
	copy(tFileOutTempM62,TRACE.Out)
	close(tFileOutTempM62)
	close(TRACE.Out)




endfunction


!===========================================================


!===========================================================

!===========================================================


!===========================================================



function bfMajtraceRubrica9740(tStatus,tError,tNumDoc,tDataDoc,tInput,tFileOut,tTipoDocumento,tMensagemErrro)
   TRACE:=new(build(sHOME,"/trace"))
   TRACE.ESTADO := tStatus
   TRACE.ERRO := tError
   TRACE.DATATRADUCAO := time("now","%Y-%m-%dT%H:%M:%S")
   TRACE.MENSAGEM := tTipoDocumento

   TRACE.PERFIL := "HARMAN"
   TRACE.SENTIDO := "I"
   TRACE.MENSAGEM := "M97.40 - RUBRICA"
   TRACE.NUMDOC := tNUMREC_9740
   TRACE.DATDOC := time("now","%Y-%m-%d")
   TRACE.MESSAGEID := build(nMessageID:R010)   

    TRACE.REDE := pEDISEND.ORIGINAL.NAME

  TRACE.SYSLOG_INDEX := build(SYSLOG.INDEX)
 TRACE.FICHEIROSAIDA := tNameOutCSV
 TRACE.LIBEXC := tLIBEXC

   if tStatus = "Recebida" then
    print(build("Ficheiro de Saida: "),tNameOutCSV,NL,NL) >> TRACE.Detail
    print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
    print("Traduzida com Sucesso",NL) >> TRACE.Detail
  
  else
          if tStatus = "Erro de Traducao" then

        print(build(time("now" ,"%Y-%m-%dT%H:%M:%S"),"\t|\t")) >> TRACE.Detail
        print("Erro de Traducao",NL) >> TRACE.Detail
        print(tMensagemErrro,NL) >> TRACE.Detail
        endif
  endif
close(TRACE.Detail)



if nMainIndex = 0 then
close(SYSLOG.a)
copy(SYSLOG.a,TRACE.In)
close(SYSLOG.a)
close(TRACE.In)

 
	nMainIndex := TRACE.INDEX
else
	tCmd := build("ln -s ", sHOME, "/trace/files/In/", nMainIndex, " ", TRACE.In)
	system(tCmd)
endif






close(tFileOutCSV)
copy(tFileOutCSV,TRACE.OutCSV)
close(tFileOutCSV)
close(TRACE.OutCSV)


flush(TRACE)
endfunction
